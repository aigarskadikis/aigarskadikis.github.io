<html><head><style type='text/css'>
.tabs .tab,.tabs input[type=radio]:checked+label{background:#fff}.tabs,.tabs label,body{display:flex}.tabs .tab,.tabs input[type=radio]{display:none}#searchResultDlg,#searchResultDlgContent{overflow:auto;overscroll-behavior:contain}#closeIcon,.tabs input[type=radio]:checked+label+.tab{display:block}.tabs{flex-wrap:wrap;width:100%}.tabs label{order:1;justify-content:center;align-items:center;padding:.1rem .5rem;margin:0;cursor:pointer}.tabs .tab{order:9;flex-grow:1;width:100%;height:1000rem;padding:.4rem}body{background:#dcdcdc;min-height:100vh;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:300;line-height:1.5;font-size:100%}pre{padding:.2em;margin:0 0 1em;background-color:#FFF7F0;border-radius:3px;border:1px solid #CCCCCC}#searchInputArea{display:flex;position:absolute;right:50px;top:5px}#searchInput{margin-left:20px;border:0}#searchInput:focus{outline:0}#searchResultDlg{display:none;flex-direction:column;position:fixed;top:50px;left:100px;right:100px;bottom:50px;padding:10px;background-color:#dcdcdc}#searchResultDlgContent{display:grid;flex-direction:column;height:100%}#closeIcon{color:#778899;font-size:55px;position:fixed;top:20px;right:50px;cursor:pointer}.resultBlock{width:100%;border-bottom:1px solid #000}.resultBlock .tabName{font-size:1.2em;font-weight:700}.tog{width:100%}
</style></head><body onLoad='initDataArray()'><div class='tabs'><div class='tog'><label for='toggler'>Use single line mode <input id='singleLineToggle' name='toggler' type='checkbox' /></label><script type='text/javascript'>if(/MSIE \d|Trident.*rv:/.test(navigator.userAgent)){document.write('<script src=../singleLine.togglerIE.js><\/script>')}else{document.write('<script src=../singleLine.toggler.js><\/script>')}</script><script>var el=document.getElementById('singleLineToggle');el.addEventListener('change',function(ev){toSingleLine(ev.target.checked)})</script></div>
<input type="radio" name="tabs" id="60" checked="checked"><label for="60">60.sql</label><ol><li><a href="#ca58b3c2f168159fe72689b1878a5794">Active problems, including Zabbix internal problems (item unsupported, trigger unsupported)</a></li><li><a href="#5c5f90bdbcf0f0d34c8447c0e9724656">ZBX hosts unreachable</a></li><li><a href="#e4d6bcdcaf0844b8434471add0af36ad">SNMP hosts unreachable</a></li><li><a href="#27d4e096992b4449576e8e526ebfac0b">Non-working external scripts</a></li><li><a href="#f16cb58e4b510dd3b89f08ceccb54789">Check native HA heartbeat</a></li><li><a href="#3f8c12fb0e6f189a488d2d05c78f485e">Show items by proxy</a></li><li><a href="#77d74f99c7e2414d0136e37694bb9efc">Difference between installed macros between host VS template VS nested/child templates</a></li><li><a href="#0fc5926be9f79bc5384efe63bd3292ad">Detect if there is difference between template macro and host macro. This is surface level detection. it does not take care of values between nested templates</a></li><li><a href="#5fdf0d3b15ae4ca17ba8cbd05ea30a52">Items in use</a></li><li><a href="#ff64207f3057eabbcff2e981d3c5b9e8">All events closed by global correlation rule</a></li><li><a href="#8ed59e20c9ab1ffb00bc15d7c7ce759e">All active data collector items on enabled hosts</a></li><li><a href="#515bb880e1666408ef79e9655e448ed5">Owner of LLD dependent item. What is interval for owner</a></li><li><a href="#f07a84e98751ca00a91f3fdb737abeb5">Enabled and disabled LLD items, its key</a></li><li><a href="#e656599a528fc46c59f8beaf20484ad6">Which dashboard has been using host group id:2 for the input</a></li><li><a href="#7478a7f3a35d71d645daffdd273369f9">Zabbix agent hitting the central server</a></li><li><a href="#6abb5308bcfd5fc6f73083971e33925e">Items without a template</a></li><li><a href="#3d561b19d4694bb3e8aeae4fc4c91976">Hosts with multiple interfaces</a></li><li><a href="#e0a8238c3b0e1381e43cb1060894ba21">PostgreSQL</a></li><li><a href="#8e7fa2f4b3e3390175badcc38141bd1f">MySQL</a></li><li><a href="#3f29f63dc2e637dbf508fbb38203a0d4">Non-working LLD rules</a></li><li><a href="#2aca5e84bf2dbe3324ff8e49760d289d">Non-working data collector items</a></li><li><a href="#624f5e432a84d397a9c44ee6ae7fe1f5">Trigger evaluation problems</a></li><li><a href="#05267d699ae612fe816cae236775c692">User sessions</a></li><li><a href="#16ef91c3a784cf67b123aa2993e6da52">Open problems</a></li><li><a href="#54680869816f3bc462114e9536d99008">Item update frequency</a></li><li><a href="#2644d6b7e06195966430d1479a01aee9">Which dashboard widgets are using wildcards</a></li><li><a href="#a66b049ef07466437da494863d47b612">Remove user refresh overrides in user level</a></li><li><a href="#c674ae604818596a4fa10e93e4243b84">Print all online users with rights group ID: 13</a></li><li><a href="#69964261e9a48cd7e569e256bf7e7ff3">For items which are currently disabled, clean the error message in database. This will help to locate what really is not working and why</a></li><li><a href="#f48c29ddfb46d241bfca2ec8062fce56">For items which are currently disabled, reset the state as supported. This will help to locate what really is not working and why. Item will remain disabled</a></li><li><a href="#c27d849693910935510c58a688d95c18">Print error message for enabled hosts and enabled data collector items</a></li><li><a href="#f5ee86973aa54c6d1016ddbfd745f7de">Identify item membership. Usefull if that is master item</a></li></ol>
<p id="ca58b3c2f168159fe72689b1878a5794">Active problems, including Zabbix internal problems (item unsupported, trigger unsupported)</p><pre><code>SELECT COUNT(*), source, object, severity FROM problem GROUP BY 2,3,4 ORDER BY severity;</code></pre>
<p id="5c5f90bdbcf0f0d34c8447c0e9724656">ZBX hosts unreachable</p><pre><code>SELECT
proxy.host AS proxy,
hosts.host,
interface.error,
CONCAT('zabbix.php?action=host.edit&hostid=', hosts.hostid) AS goTo
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
JOIN interface ON (interface.hostid=hosts.hostid)
WHERE LENGTH(interface.error) > 0
AND interface.type=1;</code></pre>
<p id="e4d6bcdcaf0844b8434471add0af36ad">SNMP hosts unreachable</p><pre><code>SELECT
proxy.host AS proxy,
hosts.host,
interface.error,
CONCAT('zabbix.php?action=host.edit&hostid=', hosts.hostid) AS goTo
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
JOIN interface ON (interface.hostid=hosts.hostid)
WHERE LENGTH(interface.error) > 0
AND interface.type=2;</code></pre>
<p id="27d4e096992b4449576e8e526ebfac0b">Non-working external scripts</p><pre><code>SELECT
hosts.host,
items.key_,
item_rtdata.error
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN item_rtdata ON (items.itemid=item_rtdata.itemid)
WHERE hosts.status=0
AND items.status=0
AND items.type=10
AND LENGTH(item_rtdata.error) > 0;</code></pre>
<p id="f16cb58e4b510dd3b89f08ceccb54789">Check native HA heartbeat</p><pre><code>SELECT * FROM ha_node;</code></pre>
<p id="3f8c12fb0e6f189a488d2d05c78f485e">Show items by proxy</p><pre><code>SELECT
COUNT(*) AS count,
proxy.host AS proxy,
items.type
FROM items
JOIN hosts ON (items.hostid=hosts.hostid)
JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND items.status=0
AND proxy.status IN (5,6)
GROUP BY 2,3
ORDER BY 2,3;</code></pre>
<p id="77d74f99c7e2414d0136e37694bb9efc">Difference between installed macros between host VS template VS nested/child templates</p><pre><code>SELECT
hm1.macro AS Macro,
child.host AS owner,
hm2.value AS defaultValue,
parent.host AS OverrideInstalled,
hm1.value AS OverrideValue
FROM hosts parent, hosts child, hosts_templates rel, hostmacro hm1, hostmacro hm2
WHERE parent.hostid=rel.hostid
AND child.hostid=rel.templateid
AND hm1.hostid=parent.hostid
AND hm2.hostid=child.hostid
AND hm1.macro=hm2.macro
AND parent.flags=0
AND child.flags=0
AND hm1.value <> hm2.value;</code></pre>
<p id="0fc5926be9f79bc5384efe63bd3292ad">Detect if there is difference between template macro and host macro. This is surface level detection. it does not take care of values between nested templates</p><pre><code>SELECT
b.host,
hm2.macro,
hm2.value AS templateValue,
h.host,
hm1.macro,
hm1.value AS hostValue
FROM hosts_templates, hosts h, hosts b, hostmacro hm1, hostmacro hm2, interface
WHERE hosts_templates.hostid=h.hostid
AND hosts_templates.templateid=b.hostid
AND interface.hostid=h.hostid
AND hm1.hostid=h.hostid
AND hm2.hostid=hosts_templates.templateid
AND hm1.macro=hm2.macro
AND hm1.value <> hm2.value;</code></pre>
<p id="5fdf0d3b15ae4ca17ba8cbd05ea30a52">Items in use</p><pre><code>SELECT
CASE items.type
WHEN 0 THEN 'Zabbix agent'
WHEN 1 THEN 'SNMPv1 agent'
WHEN 2 THEN 'Zabbix trapper'
WHEN 3 THEN 'Simple check'
WHEN 4 THEN 'SNMPv2 agent'
WHEN 5 THEN 'Zabbix internal'
WHEN 6 THEN 'SNMPv3 agent'
WHEN 7 THEN 'Zabbix agent (active) check'
WHEN 8 THEN 'Aggregate'
WHEN 9 THEN 'HTTP test (web monitoring scenario step)'
WHEN 10 THEN 'External check'
WHEN 11 THEN 'Database monitor'
WHEN 12 THEN 'IPMI agent'
WHEN 13 THEN 'SSH agent'
WHEN 14 THEN 'TELNET agent'
WHEN 15 THEN 'Calculated'
WHEN 16 THEN 'JMX agent'
WHEN 17 THEN 'SNMP trap'
WHEN 18 THEN 'Dependent item'
WHEN 19 THEN 'HTTP agent'
WHEN 20 THEN 'SNMP agent'
WHEN 21 THEN 'Script item'
END AS type,
COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND items.status=0
GROUP BY items.type
ORDER BY COUNT(*) DESC;</code></pre>
<p id="ff64207f3057eabbcff2e981d3c5b9e8">All events closed by global correlation rule</p><pre><code>SELECT
repercussion.clock,
repercussion.name,
rootCause.clock,
rootCause.name AS name
FROM events repercussion
JOIN event_recovery ON (event_recovery.eventid=repercussion.eventid)
JOIN events rootCause ON (rootCause.eventid=event_recovery.c_eventid)
WHERE event_recovery.c_eventid IS NOT NULL
ORDER BY repercussion.clock ASC;</code></pre>
<p id="8ed59e20c9ab1ffb00bc15d7c7ce759e">All active data collector items on enabled hosts</p><pre><code>SELECT hosts.host, items.name, items.type, items.key_, items.delay
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND items.status=0
ORDER BY 1,2,3,4,5;</code></pre>
<p id="515bb880e1666408ef79e9655e448ed5">Owner of LLD dependent item. What is interval for owner</p><pre><code>SELECT master_itemid.key_, master_itemid.delay, COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN items master_itemid ON (master_itemid.itemid=items.master_itemid)
WHERE items.flags=1
AND hosts.status=0
AND items.status=0
AND master_itemid.status=0
AND items.type=18
GROUP BY 1,2 ORDER BY 3 DESC;</code></pre>
<p id="f07a84e98751ca00a91f3fdb737abeb5">Enabled and disabled LLD items, its key</p><pre><code>SELECT
items.type,
items.key_,
items.delay,
items.status,
COUNT(*) AS count
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND items.flags=1
AND hosts.status=0
GROUP BY 1,2,3,4 ORDER BY 1,2,3,4;</code></pre>
<p id="e656599a528fc46c59f8beaf20484ad6">Which dashboard has been using host group id:2 for the input</p><pre><code>SELECT
DISTINCT dashboard.name,
hstgrp.name
FROM widget_field
JOIN widget ON (widget.widgetid=widget_field.widgetid)
JOIN dashboard_page ON (dashboard_page.dashboard_pageid=widget.dashboard_pageid)
JOIN dashboard ON (dashboard.dashboardid=dashboard_page.dashboardid)
JOIN hstgrp ON (hstgrp.groupid=widget_field.value_groupid)
WHERE widget_field.value_groupid IN (2);</code></pre>
<p id="7478a7f3a35d71d645daffdd273369f9">Zabbix agent hitting the central server</p><pre><code>SELECT
hosts.host AS proxy,
CASE autoreg_host.flags
WHEN 0 THEN 'IP address, do not update host interface'
WHEN 1 THEN 'IP address, update default host interface'
WHEN 2 THEN 'DNS name, update default host interface'
END AS "connect using",
CASE autoreg_host.tls_accepted
WHEN 1 THEN 'Unencrypted'
WHEN 2 THEN 'TLS with PSK'
END AS "Encryption",
COUNT(*) AS "amount of hosts"
FROM autoreg_host
JOIN hosts ON (hosts.hostid=autoreg_host.proxy_hostid)
GROUP BY 1,2,3 ORDER BY 1,2,3;</code></pre>
<p id="6abb5308bcfd5fc6f73083971e33925e">Items without a template</p><pre><code>SELECT
hosts.host,
items.key_
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND hosts.flags=0
AND items.status=0
AND items.templateid IS NULL
AND items.flags=0;</code></pre>
<p id="3d561b19d4694bb3e8aeae4fc4c91976">Hosts with multiple interfaces</p><pre><code>SELECT
hosts.host
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
WHERE hosts.flags=0
GROUP BY hosts.host
HAVING COUNT(interface.interfaceid) > 1;</code></pre>
<p id="e0a8238c3b0e1381e43cb1060894ba21">PostgreSQL</p><pre><code>SELECT
proxy.host AS proxy,
hosts.host,
ARRAY_TO_STRING(ARRAY_AGG(template.host),', ') AS templates
FROM hosts
JOIN hosts_templates ON (hosts_templates.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
LEFT JOIN hosts template ON (hosts_templates.templateid=template.hostid)
WHERE hosts.status IN (0,1)
AND hosts.flags=0
GROUP BY 1,2 ORDER BY 1,3,2;</code></pre>
<p id="8e7fa2f4b3e3390175badcc38141bd1f">MySQL</p><pre><code>SELECT
proxy.host AS proxy,
hosts.host,
GROUP_CONCAT(template.host SEPARATOR ', ') AS templates
FROM hosts
JOIN hosts_templates ON (hosts_templates.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
LEFT JOIN hosts template ON (hosts_templates.templateid=template.hostid)
WHERE hosts.status IN (0,1)
AND hosts.flags=0
GROUP BY 1,2 ORDER BY 1,3,2;</code></pre>
<p id="3f29f63dc2e637dbf508fbb38203a0d4">Non-working LLD rules</p><pre><code>SELECT
hosts.name AS hostName,
items.key_ AS itemKey,
problem.name AS LLDerror,
CONCAT('host_discovery.php?form=update&itemid=', problem.objectid) AS goTo
FROM problem
JOIN items ON (items.itemid=problem.objectid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE problem.source > 0
AND problem.object=5;</code></pre>
<p id="2aca5e84bf2dbe3324ff8e49760d289d">Non-working data collector items</p><pre><code>SELECT
hosts.name AS hostName,
items.key_ AS itemKey,
problem.name AS DataCollectorError,
CONCAT('items.php?form=update&itemid=', problem.objectid) AS goTo
FROM problem
JOIN items ON (items.itemid=problem.objectid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE problem.source > 0
AND problem.object=4;</code></pre>
<p id="624f5e432a84d397a9c44ee6ae7fe1f5">Trigger evaluation problems</p><pre><code>SELECT
DISTINCT CONCAT('triggers.php?form=update&triggerid=', problem.objectid) AS goTo,
hosts.name AS hostName,
triggers.description AS triggerTitle,
problem.name AS TriggerEvaluationError
FROM problem
JOIN triggers ON (triggers.triggerid=problem.objectid)
JOIN functions ON (functions.triggerid=triggers.triggerid)
JOIN items ON (items.itemid=functions.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE problem.source > 0
AND problem.object=0;</code></pre>
<p id="05267d699ae612fe816cae236775c692">User sessions</p><pre><code>SELECT
COUNT(*),
users.username
FROM sessions
JOIN users ON (users.userid=sessions.userid)
GROUP BY 2 ORDER BY 1 ASC;</code></pre>
<p id="16ef91c3a784cf67b123aa2993e6da52">Open problems</p><pre><code>SELECT
COUNT(*) AS count,
CASE
WHEN source=0 THEN 'surface'
WHEN source > 0 THEN 'internal'
END AS level,
CASE
WHEN source=0 AND object=0 THEN 'trigger in a problem state'
WHEN source=3 AND object=0 THEN 'cannot evaluate trigger expression'
WHEN source=3 AND object=4 THEN 'data collection not working'
WHEN source=3 AND object=5 THEN 'low level discovery not perfect'
END AS problemCategory
FROM problem GROUP BY 2,3
ORDER BY 2 DESC;</code></pre>
<p id="54680869816f3bc462114e9536d99008">Item update frequency</p><pre><code>SELECT
h2.host AS Source,
i2.name AS itemName,
i2.key_ AS itemKey,
i2.delay AS OriginalUpdateFrequency,
h1.host AS exceptionInstalledOn,
i1.delay AS FrequencyChild,
CASE
WHEN i1.flags=1 THEN 'LLD rule'
WHEN i1.flags IN (0,4) THEN 'data collection'
END AS itemCategory,
CASE
WHEN i1.flags=1 THEN CONCAT('host_discovery.php?form=update&context=host&itemid=', i1.itemid)
WHEN i1.flags IN (0,4) THEN CONCAT('items.php?form=update&context=host&hostid=', h1.hostid, '&itemid=',i1.itemid)
END AS goTo
FROM items i1
JOIN items i2 ON (i2.itemid=i1.templateid)
JOIN hosts h1 ON (h1.hostid=i1.hostid)
JOIN hosts h2 ON (h2.hostid=i2.hostid)
WHERE i1.delay <> i2.delay;</code></pre>
<p id="2644d6b7e06195966430d1479a01aee9">Which dashboard widgets are using wildcards</p><pre><code>SELECT
value_str AS pattern,
widget.name AS widgetName,
dashboard.name AS dashboardName
FROM widget_field, widget, dashboard_page, dashboard
WHERE widget_field.value_str like '%*%'
AND widget.widgetid=widget_field.widgetid
AND dashboard_page.dashboard_pageid=widget.dashboard_pageid
AND dashboard.dashboardid=dashboard_page.dashboard_pageid
ORDER BY 3,2,1;</code></pre>
<p id="a66b049ef07466437da494863d47b612">Remove user refresh overrides in user level</p><pre><code>DELETE FROM profiles WHERE idx='web.dashboard.widget.rf_rate';</code></pre>
<p id="c674ae604818596a4fa10e93e4243b84">Print all online users with rights group ID: 13</p><pre><code>SELECT
users.username,
CASE
WHEN permission=0 THEN 'DENY'
WHEN permission=2 THEN 'READ_ONLY'
WHEN permission=3 THEN 'READ_WRITE'
END AS permission,
hstgrp.name AS name
FROM users, users_groups, sessions, usrgrp, rights, hstgrp
WHERE sessions.status=0
AND rights.groupid=13
AND users.userid=users_groups.userid
AND users.userid=sessions.userid
AND users_groups.usrgrpid=usrgrp.usrgrpid
AND users_groups.userid=users.userid
AND usrgrp.usrgrpid=rights.groupid
AND rights.id=hstgrp.groupid;</code></pre>
<p id="69964261e9a48cd7e569e256bf7e7ff3">For items which are currently disabled, clean the error message in database. This will help to locate what really is not working and why</p><pre><code>UPDATE item_rtdata
SET error=''
WHERE state=1
AND itemid IN (
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status=0
AND items.status=1
);</code></pre>
<p id="f48c29ddfb46d241bfca2ec8062fce56">For items which are currently disabled, reset the state as supported. This will help to locate what really is not working and why. Item will remain disabled</p><pre><code>UPDATE item_rtdata
SET state=0
WHERE state=1
AND itemid IN (
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status=0
AND items.status=1
);</code></pre>
<p id="c27d849693910935510c58a688d95c18">Print error message for enabled hosts and enabled data collector items</p><pre><code>SELECT
hosts.host,
items.name,
item_rtdata.error AS error
FROM item_rtdata, items, hosts
WHERE item_rtdata.state=1
AND hosts.status=0
AND items.status=0
AND item_rtdata.itemid=items.itemid
AND hosts.hostid=items.hostid;</code></pre>
<p id="f5ee86973aa54c6d1016ddbfd745f7de">Identify item membership. Usefull if that is master item</p><pre><code>SELECT
proxy.host AS proxy,
hosts.host,
items.name,
items.key_,
items.delay AS delay
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
JOIN items ON (items.hostid=hosts.hostid)
WHERE items.itemid IN (12345,5678);</code></pre>
<p>Download this section: <a href="src/60.sql">https://aigarskadikis.github.io/src/60.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/60.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/60.sql</a></p>
</div>
</div><div id='searchInputArea'><span>SEARCH</span><input type='text' id='searchInput' placeholder='Type at least 1 characters...' onkeyup='onTypeSearchInput(event)' /></div><div id='searchResultDlg'><div id='closeIcon' onclick='onCloseDlg()'>&times;</div><div id='searchResultDlgContent'></div></div><script src='../searcher.js'></script></body></html>
