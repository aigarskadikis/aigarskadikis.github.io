<html><head><link rel='stylesheet' type='text/css' href='./src/css.css' />
</head><body onLoad='initDataArray()'><div class='tabs'><div class='tog'><label for='toggler'>Use single line mode <input id='singleLineToggle' name='toggler' type='checkbox' /></label><script type='text/javascript'>if(/MSIE \d|Trident.*rv:/.test(navigator.userAgent)){document.write('<script src=singleLine.togglerIE.js><\/script>')}else{document.write('<script src=singleLine.toggler.js><\/script>')}</script><script>var el=document.getElementById('singleLineToggle');el.addEventListener('change',function(ev){toSingleLine(ev.target.checked)})</script></div>
<input type="radio" name="tabs" id="backup"><label for="backup">backup</label><div class="tab">
Process list<pre><code>mysql \
--host=dns.of.ip \
--user=root \
--password='zabbix' \
--database=zabbix \
--execute="
SHOW FULL PROCESSLIST;
" > /tmp/mysql.process.list.$(date +%Y%m%d.%H%M).txt</code></pre>
Backup directories which can be related to Zabbix<pre><code>cd /usr/share/zabbix && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/zabbix && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /usr/lib/zabbix && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/cron.d && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /usr/local/bin && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/nginx/conf.d && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/php-fpm.d && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}</code></pre>
Create a backup user<pre><code>mysql -e "
CREATE USER 'zbx_backup'@'127.0.0.1' IDENTIFIED BY 'zabbix';
GRANT LOCK TABLES, SELECT ON zabbix.* TO 'zbx_backup'@'127.0.0.1';
GRANT RELOAD ON *.* TO 'zbx_backup'@'127.0.0.1';
FLUSH PRIVILEGES;
"</code></pre>
Install credentials file for read-only backup<pre><code>cat << 'EOF' > /etc/zabbix/zabbix_backup.cnf
[mysqldump]
host=127.0.0.1
user=zbx_backup
password=zabbix
EOF</code></pre>
30 days configuration backup if MySQL 8<pre><code>BACKUP_DIR=/backup
DBNAME=zabbix
DATE=$(date +%Y%m%d.%H%M)
mkdir -p "$BACKUP_DIR"
echo "schema"
mysqldump \
--defaults-file=/etc/zabbix/zabbix_backup.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--create-options \
--no-data \
$DBNAME | gzip --fast > "$BACKUP_DIR/schema.sql.gz" && \
echo "data" && mysqldump \
--defaults-file=/etc/zabbix/zabbix_backup.cnf \
--flush-logs \
--single-transaction \
--no-tablespaces \
--set-gtid-purged=OFF \
--ignore-table=$DBNAME.history \
--ignore-table=$DBNAME.history_log \
--ignore-table=$DBNAME.history_str \
--ignore-table=$DBNAME.history_text \
--ignore-table=$DBNAME.history_uint \
--ignore-table=$DBNAME.trends \
--ignore-table=$DBNAME.trends_uint \
$DBNAME > "$BACKUP_DIR/data.sql" && \
echo "compressing data" && gzip --fast "$BACKUP_DIR/data.sql" && \
echo "quick restore" && mysqldump \
--defaults-file=/etc/zabbix/zabbix_backup.cnf \
--flush-logs \
--single-transaction \
--ignore-table=$DBNAME.history \
--ignore-table=$DBNAME.history_log \
--ignore-table=$DBNAME.history_str \
--ignore-table=$DBNAME.history_text \
--ignore-table=$DBNAME.history_uint \
--ignore-table=$DBNAME.trends \
--ignore-table=$DBNAME.trends_uint \
$DBNAME > "$BACKUP_DIR/quick.restore.sql" && \
echo "compressing quick restore" && gzip --fast "$BACKUP_DIR/quick.restore.sql"
mv "$BACKUP_DIR/schema.sql.gz" "$BACKUP_DIR/schema.$DATE.sql.gz"
mv "$BACKUP_DIR/data.sql.gz" "$BACKUP_DIR/data.$DATE.sql.gz"
mv "$BACKUP_DIR/quick.restore.sql.gz" "$BACKUP_DIR/quick.restore.$DATE.sql.gz"
find /backup -type f -mtime +30
find /backup -type f -mtime +30 -delete</code></pre>
Mariadb backup<pre><code>BACKUP_DIR=/backup
KEEP_DAYS=90
DBNAME=zabbix
DATE=$(date +%Y%m%d.%H%M)
mkdir -p "$BACKUP_DIR"
echo "schema"
mysqldump \
--defaults-file=~/zabbix_backup.cnf \
--flush-logs \
--single-transaction \
--create-options \
--no-data \
$DBNAME | gzip --fast > "$BACKUP_DIR/schema.sql.gz" && \
echo "data" && \
mysqldump \
--defaults-file=~/zabbix_backup.cnf \
--flush-logs \
--single-transaction \
--no-tablespaces \
--ignore-table=$DBNAME.history \
--ignore-table=$DBNAME.history_log \
--ignore-table=$DBNAME.history_str \
--ignore-table=$DBNAME.history_text \
--ignore-table=$DBNAME.history_uint \
--ignore-table=$DBNAME.trends \
--ignore-table=$DBNAME.trends_uint \
$DBNAME > "$BACKUP_DIR/data.sql" && \
echo "compressing data" && gzip --fast "$BACKUP_DIR/data.sql" && \
echo "snapshot" && mysqldump \
--defaults-file=~/zabbix_backup.cnf \
--flush-logs \
--single-transaction \
--ignore-table=$DBNAME.history \
--ignore-table=$DBNAME.history_log \
--ignore-table=$DBNAME.history_str \
--ignore-table=$DBNAME.history_text \
--ignore-table=$DBNAME.history_uint \
--ignore-table=$DBNAME.trends \
--ignore-table=$DBNAME.trends_uint \
$DBNAME > "$BACKUP_DIR/snapshot.sql" && \
echo "compressing snapshot" && gzip --fast "$BACKUP_DIR/snapshot.sql" && \
mv "$BACKUP_DIR/schema.sql.gz" "$BACKUP_DIR/schema.$DATE.sql.gz" && \
mv "$BACKUP_DIR/data.sql.gz" "$BACKUP_DIR/data.$DATE.sql.gz" && \
mv "$BACKUP_DIR/snapshot.sql.gz" "$BACKUP_DIR/snapshot.$DATE.sql.gz"
if [ -d "$BACKUP_DIR" ]; then
echo "deleting files older than $KEEP_DAYS days:"
find "$BACKUP_DIR" -maxdepth 1 -type f -name '*.gz' -mtime +$KEEP_DAYS
find "$BACKUP_DIR" -maxdepth 1 -type f -name '*.gz' -mtime +$KEEP_DAYS -delete
fi</code></pre>
Rotate backups for 30 days<pre><code>find /backup -type f -mtime +30
find /backup -type f -mtime +30 -delete</code></pre>
Insert to a temporary table<pre><code>zcat trends_uint.sql.gz | sed 's|trends_uint|trends_uint_old|' | mysql zabbix
zcat history_uint.sql.gz | sed 's|history_uint|history_uint_old|' | mysql zabbix
zcat trends.sql.gz | sed 's|trends|trends_old|' | mysql zabbix
zcat history.sql.gz | sed 's|history|history_old|' | mysql zabbix</code></pre>
Backup to a remote system<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--single-transaction \
--no-create-info \
zabbix history_text \
--where="clock BETWEEN 1690257300 AND 1690279380" | \
gzip --stdout | ssh root@192.168.88.15 "cat > /dev/shm/history_text.sql.gz"</code></pre>
Backup and compress zabbix server config with a purpose to restore it on other machine<pre><code>tar --create --verbose --use-compress-program='gzip -9' /etc/zabbix/zabbix_server.conf | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | gunzip | tar -xv%' && echo</code></pre>
Backup and compress Zabbix agent 2 config with a purpose to restore it on other machine<pre><code>tar --create --verbose --use-compress-program='gzip -9' /etc/zabbix/zabbix_agent2.conf | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | gunzip | tar -xv%' && echo</code></pre>
Backup and compress partitioning script and configuration files<pre><code>tar --create --verbose --use-compress-program='gzip -9' /etc/zabbix/zabbix_partitioning.conf /usr/local/bin/zabbix_partitioning.py /etc/cron.d/zabbix_partitioning | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | gunzip | tar -xv%' && echo</code></pre>
Backup all frontend modules with 'xz' compression<pre><code>tar --create --verbose --use-compress-program='xz -9' /usr/share/zabbix/modules | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | unxz | tar -xv%' && echo</code></pre>
<p>Download this section: <a href="src/backup.sh">https://aigarskadikis.github.io/src/backup.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/backup.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/backup.sh</a></p>
</div>
<input type="radio" name="tabs" id="bash"><label for="bash">bash</label><div class="tab">
Hog processes, hog<pre><code>ps -eo pcpu,pmem,pid,ppid,user,stat,args | sort -k 1 -r | head -6 | sed 's/$/\n/'</code></pre>
Rotate between values<pre><code>echo "
one
two
" | grep -v "^$" | while IFS= read -r LINE
do {
echo $LINE
} done</code></pre>
Remove leading and trailing space with sed<pre><code>sed 's/^[\t ]*//g;s/[\t ]*$//g'</code></pre>
Endless loop to deliver metric<pre><code>while true; do zabbix_sender -z 127.0.0.1 -s $(hostname) -k agent.ping -o 1; sleep 30; done</code></pre>
Test disk throughput<pre><code>dd if=/dev/urandom of=/db/mount/point/512M bs=1M count=512 oflag=direct
dd if=/dev/urandom of=/db/mount/point/5GB bs=1M count=5120 oflag=direct
dd if=/dev/urandom of=/db/mount/point/50GB bs=1M count=51200 oflag=direct
dd if=/dev/urandom of=/db/mount/point/65GB bs=1M count=65536 oflag=direct</code></pre>
Simulate javascript code without placing file in filesystem<pre><code>zabbix_js --script <(echo 'return 1;') --param '' --loglevel 4 --timeout 60</code></pre>
Feed the output of file into javascript program<pre><code>zabbix_js --script <(echo 'return value;') --loglevel 3 --timeout 60 --input <(grep -v "^$\|#" /etc/zabbix/zabbix_agentd.conf | sort)</code></pre>
Erase dublicate data in table 'history_text'. This does NOT work like discard unchanged<pre><code>mysql \
--database='zabbix' \
--silent \
--skip-column-names \
--batch \
--execute="
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status IN (0,1)
AND items.value_type=4
AND items.flags IN (0,4)
" | \
while IFS= read -r ITEMID
do {
echo $ITEMID
sleep 0.01
echo "
DELETE t1 FROM history_text t1
INNER JOIN history_text t2
WHERE t1.clock < t2.clock
AND t1.value=t2.value
AND t1.itemid=t2.itemid
AND t1.itemid=$ITEMID
" | mysql zabbix
} done</code></pre>
Print metrics on screen<pre><code>while true; do
echo -n 'total: ' && zabbix_get -s 127.0.0.1 -k system.cpu.util[];
echo -n 'user: ' && zabbix_get -s 127.0.0.1 -k system.cpu.util[,user];
echo -n 'system: '&& zabbix_get -s 127.0.0.1 -k system.cpu.util[,system];
echo -n 'guest: ' && zabbix_get -s 127.0.0.1 -k system.cpu.util[,guest];
echo -n 'guest_nice: ' && zabbix_get -s 127.0.0.1 -k system.cpu.util[,guest_nice];
echo '------------'
sleep 1; done;</code></pre>
Compress /var/lib/mysql by using gzip<pre><code>tar --create --verbose --use-compress-program='gzip --fast' --file=/tmp/var.lib.mysql.tar.gz /var/lib/mysql</code></pre>
Restore<pre><code>rm /var/lib/mysql/* -rf
tar xvf /tmp/var.lib.mysql.tar.gz --directory=/var/lib/mysql</code></pre>
Compress /var/lib/mysql by using lz4<pre><code>dnf install lz4
tar --create --verbose --use-compress-program='lz4' --file=/tmp/var.lib.mysql.tar.lz4 /var/lib/mysql</code></pre>
Restore<pre><code>rm /var/lib/mysql/* -rf
cd /
unlz4 /tmp/var.lib.mysql.tar.lz4 | tar xvf -</code></pre>
Track when trends are completed<pre><code>watch -n.2 'mysql -e "show full processlist;" | grep insert'</code></pre>
Take poller #11, increase log level to 5 and stream live situation of what kind of items are fetched and how fast. Zabbix 6.0, 6.2, 6.4<pre><code>zabbix_proxy -R log_level_increase="poller",11
zabbix_proxy -R log_level_increase="poller",11
tail -999f /var/log/zabbix/zabbix_proxy.log | grep "$(ps auxww | grep ":[ ]poller #11 " | awk '{ print $2 }')" | grep -E 'interfaceid:\S+ itemid:\S+ type:\S+|zbx_setproctitle.*idle'</code></pre>
Take poller #11, increase log level to 5 and stream live situation of what kind of items are fetched and how fast. Zabbix 5.0<pre><code>zabbix_proxy -R log_level_increase="poller",1
zabbix_proxy -R log_level_increase="poller",1
tail -999f /var/log/zabbix/zabbix_proxy.log | grep "$(ps auxww | grep ":[ ]poller #1 " | awk '{ print $2 }')" | grep -E 'hostid:\S+ itemid:\S+ type:\S+|zbx_setproctitle.*idle'
tail -99f /var/log/zabbix/zabbix_proxy.log | grep "$(ps auxww | grep ":[ ]poller #1 " | awk '{ print $2 }')" | grep -Eo 'hostid:\S+ itemid:\S+ type:\S+|got.*sec.*idle'</code></pre>
Outgoing ports, persistent connection<pre><code>ss --tcp --numeric --processes | grep zabbix_server</code></pre>
Process list with parents<pre><code>ps -xafuww > /tmp/process.list.$(hostname).txt</code></pre>
Top memory processes<pre><code>ps -eo pcpu,pmem,user,stat,args --sort -rss > /tmp/$(hostname).top.memory.processes.txt</code></pre>
Hungry CPU processes<pre><code>ps -eo pcpu,pmem,user,stat,args --sort -time > /tmp/$(hostname).hungry.cpu.processes.txt</code></pre>
All socket statistics<pre><code>ss --tcp --numeric --processes > /tmp/$(hostname).socket.statistics.txt</code></pre>
Only listening ports and explanation<pre><code>ss --tcp --numeric --listen --processes > /tmp/$(hostname).listening.ports.txt</code></pre>
All installed package names<pre><code>rpm -qa > /tmp/$(hostname).installed.rpms.txt</code></pre>
Generate random password by using bash tools<pre><code>< /dev/urandom tr -dc A-Za-z0-9 | head -c${1:-20};echo;</code></pre>
Php official memory setting<pre><code>find /etc -name zabbix.conf -exec grep --with-filename memory {} \;</code></pre>
A sum per column<pre><code>ls -lb | grep "history_str#" | awk '{ print $5 }' | python -c "import sys; print(sum(int(l) for l in sys.stdin))"</code></pre>
Test item key<pre><code>zabbix_agent2 -t 'web.certificate.get[www.linkedin.com,443,]'
su zabbix --shell /bin/bash --command "zabbix_agent2 -t 'web.certificate.get[www.linkedin.com,443,]'"</code></pre>
Backup<pre><code>psql z50 -c "COPY (SELECT * FROM trends) TO stdout DELIMITER ',' CSV" | lz4 > /tmp/z50.trends.csv.lz4
psql z50 -c "COPY (SELECT * FROM trends_uint) TO stdout DELIMITER ',' CSV" | lz4 > /tmp/z50.trends_uint.csv.lz4</code></pre>
Restore<pre><code>psql z50 -c "\COPY trends FROM PROGRAM 'lz4cat /tmp/z50.trends.csv.lz4' DELIMITER ',' CSV"
psql z50 -c "\COPY trends_uint FROM PROGRAM 'lz4cat /tmp/z50.trends_uint.csv.lz4' DELIMITER ',' CSV"</code></pre>
Erase dublicate data in table 'history_str'. This does NOT work like discard unchanged<pre><code>mysql \
--database='zabbix' \
--silent \
--skip-column-names \
--batch \
--execute="
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status IN (0,1)
AND items.value_type=1
AND items.flags IN (0,4)
" | \
while IFS= read -r ITEMID
do {
echo $ITEMID
sleep 0.01
echo "
DELETE t1 FROM history_str t1
INNER JOIN history_str t2
WHERE t1.clock < t2.clock
AND t1.value=t2.value
AND t1.itemid=t2.itemid
AND t1.itemid=$ITEMID
" | mysql zabbix
} done</code></pre>
Discard unchanged 'history_text' for all item IDs<pre><code>mysql \
--database='zabbix' \
--silent \
--skip-column-names \
--batch \
--execute="
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status IN (0,1)
AND items.value_type=4
AND items.flags IN (0,4)
" | \
while IFS= read -r ITEMID
do {
echo $ITEMID
sleep 0.01
echo "
DELETE FROM history_text WHERE itemid=$ITEMID AND clock IN (
SELECT clock from (
SELECT clock, value, r, v2 FROM (
SELECT clock, value, LEAD(value,1) OVER (order by clock) AS v2,
CASE
WHEN value <> LEAD(value,1) OVER (order by clock)
THEN value
ELSE 'zero'
END AS r
FROM history_text WHERE itemid=$ITEMID
) x2
where r = 'zero'
) x3
WHERE v2 IS NOT NULL
)
" | mysql zabbix
} done</code></pre>
Discard unchanged 'history_str' for all item IDs<pre><code>mysql \
--database='zabbix' \
--silent \
--skip-column-names \
--batch \
--execute="
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status IN (0,1)
AND items.value_type=1
AND items.flags IN (0,4)
" | \
while IFS= read -r ITEMID
do {
echo $ITEMID
sleep 0.01
echo "
DELETE FROM history_str WHERE itemid=$ITEMID AND clock IN (
SELECT clock from (
SELECT clock, value, r, v2 FROM (
SELECT clock, value, LEAD(value,1) OVER (order by clock) AS v2,
CASE
WHEN value <> LEAD(value,1) OVER (order by clock)
THEN value
ELSE 'zero'
END AS r
FROM history_str WHERE itemid=$ITEMID
) x2
where r = 'zero'
) x3
WHERE v2 IS NOT NULL
)
" | mysql zabbix
} done</code></pre>
Before starting service 'zabbix-proxy' truncate all data tables<pre><code>DB=zabbix_proxy
CREDENTIALS=/root/.my.cnf
mysql \
--defaults-file=$CREDENTIALS \
--database=$DB \
--silent \
--skip-column-names \
--batch \
--execute="SELECT COUNT(*) FROM hosts WHERE status=3;" | \
grep -E "^0$" && mysql \
--defaults-file=$CREDENTIALS \
--database=$DB \
--silent \
--skip-column-names \
--batch \
--execute="SELECT table_name FROM ids" | while IFS= read -r TABLE
do {
echo mysql --defaults-file=$CREDENTIALS --database=$DB --execute="TRUNCATE TABLE $TABLE"
} done || echo "this seems like a central zabbix server, because there are template objects in database"</code></pre>
<p>Download this section: <a href="src/bash.sh">https://aigarskadikis.github.io/src/bash.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/bash.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/bash.sh</a></p>
</div>
<input type="radio" name="tabs" id="el8"><label for="el8">el8</label><div class="tab">
Zabbix 6.0 LTS repository<pre><code>rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-2.el8.noarch.rpm</code></pre>
Familiar utilities<pre><code>dnf -y install strace vim tmux jq zabbix-get zabbix-sender zabbix-js</code></pre>
SNMP trap dependencies. Snmptrap (net-snmp-utils), snmpwalk (net-snmp-utils), snmptrapd (net-snmp), dependencies for zabbix_trap_receiver.pl (net-snmp-perl)<pre><code>dnf -y install net-snmp-utils net-snmp-perl net-snmp</code></pre>
Python 3 with YAML and MySQL connector support<pre><code>dnf -y install python3 python3-PyMySQL python3-PyYAML</code></pre>
Install MySQL server on Oracle Linux 8, RHEL 8, Rocky Linux 8<pre><code>dnf -y install mysql-server</code></pre>
Work with Zabbix source<pre><code>dnf -y install git automake gcc</code></pre>
<p>Download this section: <a href="src/el8.sh">https://aigarskadikis.github.io/src/el8.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/el8.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/el8.sh</a></p>
</div>
<input type="radio" name="tabs" id="get"><label for="get">get</label><div class="tab">
MySQL monitoring through Zabbix agent 2<pre><code>zabbix_get -s 127.0.0.1 -k 'mysql.get_status_variables["tcp://127.0.0.1:3306","zbx_monitor","zabbix"]'</code></pre>
PostgreSQL monitoring through Zabbix agent 2<pre><code>zabbix_get -s 127.0.0.1 -k 'pgsql.dbstat["tcp://127.0.0.1:5432","zbx_monitor","zabbix"]'</code></pre>
Oracle 19c monitoring through Zabbix agent 2<pre><code>zabbix_get -s 127.0.0.1 -k 'oracle.instance.info["tcp://127.0.0.1:1521","zabbix_mon","zabbix","ORCLPDB1"]'</code></pre>
<p>Download this section: <a href="src/get.sh">https://aigarskadikis.github.io/src/get.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/get.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/get.sh</a></p>
</div>
<input type="radio" name="tabs" id="grep"><label for="grep">grep</label><div class="tab">
Check if master processes is runnign from server, proxy or agent<pre><code>ps auxww | grep "[z]abbix.*conf"</code></pre>
How long takes one configuration synchronization cycle. Command suitable for "zabbix_server" and "zabbix_proxy"<pre><code>ps auxww | grep "[c]onfiguration.*synced"</code></pre>
Zabbix server configuration file<pre><code>grep -v "^$\|#" /etc/zabbix/zabbix_server.conf | sort</code></pre>
Observe credentials how zabbix-server-mysql connects to database<pre><code>grep ^DB /etc/zabbix/zabbix_server.conf
grep "DB\|Include" /etc/zabbix/zabbix_server.conf | grep -v '#'</code></pre>
"trapper" processes of zabbix_server or zabbix_proxy<pre><code>ps auxww | grep '[:] trapper'</code></pre>
"history syncer" of zabbix_server or zabbix_proxy<pre><code>ps auxww | grep '[:] history syncer'</code></pre>
All restarts. Gracefull restarts<pre><code>grep "Starting Zabbix Server\|Zabbix Server stopped" /var/log/zabbix/zabbix_server.log
zcat /var/log/zabbix/zabbix_server*gz | grep "Starting Zabbix Server\|Zabbix Server stopped"</code></pre>
Check slow queries<pre><code>grep "slow query" /var/log/zabbix/zabbix_server.log</code></pre>
Differences between backend nodes<pre><code>grep -r '=' /etc/zabbix/zabbix_server.d/*</code></pre>
How much time take for housekeeper process to complete<pre><code>grep housekeeper /var/log/zabbix/zabbix_server.log</code></pre>
Most busy item for preprocessing worker<pre><code>grep zabbix_server.log | grep -Eo "In preprocessor_enqueue_dependent.*" | sort | uniq -c | sort</code></pre>
<p>Download this section: <a href="src/grep.sh">https://aigarskadikis.github.io/src/grep.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/grep.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/grep.sh</a></p>
</div>
<input type="radio" name="tabs" id="my"><label for="my">my</label><div class="tab">
List of MySQL tables/partitions by size<pre><code>du -ab /var/lib/mysql > /tmp/size.of.tables.txt
du -ah /var/lib/mysql > /tmp/size.of.tables.human.readable.txt</code></pre>
Backup data directory. Fastest way time-wise<pre><code>systemctl stop mysqld
tar --create --verbose --use-compress-program='gzip --fast' --file=/tmp/var.lib.mysql.tar.gz /var/lib/mysql</code></pre>
Check "Max open files" for MySQL daemon. This is important if a lot of DB table partition are used<pre><code>cat /proc/$(ps auxww | grep "[m]ysqld" | awk '{print $2}')/limits | grep "Max open files"</code></pre>
Authorize in MySQL<pre><code>mysql --host=127.0.0.1 --database=zabbixDB --user=zbx_srv --password='zabbix' --port=3306</code></pre>
Track how DB table partitions grow<pre><code>cd /var/lib/mysql/zabbix && watch -n1 'ls -Rltr | tail -10'</code></pre>
List of open files per MySQL server. If tables has a lot of partitions it will be a lot of files<pre><code>lsof -p $(pidof mysqld) > /tmp/mysqld.list.open.files.txt</code></pre>
How much data is generated in 24h<pre><code>du -lah /var/lib/mysql/zabbix | grep "$(date --date='2 days ago' '+p%Y_%m_%d')"
du -lah /var/lib/mysql/zabbix | grep "$(date --date='2 days ago' '+p%Y%m%d0000')"</code></pre>
Track progress of "OPTIMIZE TABLE" in MySQL<pre><code>watch -n1 "ls -Rltr /var/lib/mysql/zabbix | grep '#sql'"</code></pre>
Schema backup for MySQL 8. Useful for scripts<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--flush-logs \
--single-transaction \
--set-gtid-purged=OFF \
--create-options \
--no-data \
zabbix | gzip --fast > schema.sql.gz</code></pre>
Create backup with a purpose to set up master to master replication<pre><code>mysqldump --source-data --all-databases \
--set-gtid-purged=OFF \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint | gzip --fast > /tmp/backup.sql.gz
chmod 777 /tmp/backup.sql.gz</code></pre>
Schema dump for historical tables only. Backup schema for 7 historical tables. usefull if need to repair replication as fast as possible<pre><code>mysqldump --set-gtid-purged=OFF --no-data zabbix history history_uint history_str history_log history_text trends trends_uint > empty.data.tables.with.partitions.sql</code></pre>
Data backup with gz compression<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--no-create-info \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix > data.sql && \
gzip data.sql</code></pre>
Data backup with xz compression<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--no-create-info \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix > data.sql && \
xz data.sql</code></pre>
Passwordless access for read-only user<pre><code>cd && cat << 'EOF' > .my.cnf
[client]
host=192.168.88.101
user=zbx_ro
password=passwd_ro_zbx
EOF</code></pre>
On-the-fly configuration backup. Check if this is not the node holding the Virtaul IP address. Do a backup on slave<pre><code>ip a | grep "192.168.88.55" || mysqldump \
--defaults-file=/root/.my.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix | gzip > quick.restore.sql.gz</code></pre>
MySQL 8.0 schema backup for MySQL 8. Credentials embeded in command<pre><code>mysqldump \
--host=127.0.0.1 \
--user=root \
--password='zabbix' \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--create-options \
--no-data \
zabbix | gzip --fast > schema.sql.gz</code></pre>
Backup "_old" tables with fastest compression possible<pre><code>DB=zabbix
DEST=/mnt/zabbixtemp
mkdir -p "$DEST"
mysqldump $DB trends_uint_old | lz4 > "$DEST/trends_uint_old.sql.lz4" &
mysqldump $DB trends_old | lz4 > "$DEST/trends_old.sql.lz4" &
mysqldump $DB history_uint_old | lz4 > "$DEST/history_uint_old.sql.lz4" &
mysqldump $DB history_old | lz4 > "$DEST/history_old.sql.lz4" &
mysqldump $DB history_str_old | lz4 > "$DEST/history_str_old.sql.lz4" &
mysqldump $DB history_log_old | lz4 > "$DEST/history_log_old.sql.lz4" &
mysqldump $DB history_text_old | lz4 > "$DEST/history_text_old.sql.lz4" &</code></pre>
MariaDB 10.3 schema backup<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--flush-logs \
--single-transaction \
--create-options \
--no-data \
zabbix > /root/schema52.sql</code></pre>
MariaDB 10.3 data backup without history<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--flush-logs \
--single-transaction \
--no-create-info \
--skip-triggers \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix | gzip --fast > /root/data52.sql.gz</code></pre>
Backup historical data individualu compress with gzip<pre><code>tmux
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix trends_uint | gzip --fast > /root/trends_uint.sql.gz
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix trends | gzip --fast > /root/trends.sql.gz
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_uint | gzip --fast > /root/history_uint.sql.gz
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history | gzip --fast > /root/history.sql.gz
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_str | gzip --fast > /root/history_str.sql.gz
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_text | gzip --fast > /root/history_text.sql.gz
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_log | gzip --fast > /root/history_log.sql.gz</code></pre>
Backup historical data individualy. Compress with lz4<pre><code>tmux
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix trends_uint | lz4 > /root/trends_uint.sql.lz4
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix trends | lz4 > /root/trends.sql.lz4
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_uint | lz4 > /root/history_uint.sql.lz4
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history | lz4 > /root/history.sql.lz4
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_str | lz4 > /root/history_str.sql.lz4
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_text | lz4 > /root/history_text.sql.lz4
mysqldump --defaults-file=/root/.my.cnf --flush-logs --single-transaction --no-create-info --skip-triggers zabbix history_log | lz4 > /root/history_log.sql.lz4</code></pre>
Backup current data tables with fastest compression possible<pre><code>DB=zabbix
DEST=/mnt/zabbixtemp
mkdir -p "$DEST"
mysqldump $DB trends_uint | lz4 > "$DEST/trends_uint.sql.lz4" &
mysqldump $DB trends | lz4 > "$DEST/trends.sql.lz4" &
mysqldump $DB history_uint | lz4 > "$DEST/history_uint.sql.lz4" &
mysqldump $DB history | lz4 > "$DEST/history.sql.lz4" &
mysqldump $DB history_str | lz4 > "$DEST/history_str.sql.lz4" &
mysqldump $DB history_log | lz4 > "$DEST/history_log.sql.lz4" &
mysqldump $DB history_text | lz4 > "$DEST/history_text.sql.lz4" &</code></pre>
Restore from sql.gz<pre><code>time zcat /root/trends_uint.sql.gz | sed 's|trends_uint|trends_uint_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time zcat /root/history_uint.sql.gz | sed 's|history_uint|history_uint_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time zcat /root/trends.sql.gz | sed 's|trends|trends_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time zcat /root/history.sql.gz | sed 's|history|history_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time zcat /root/history_str.sql.gz | sed 's|history_str|history_str_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time zcat /root/history_text.sql.gz | sed 's|history_text|history_text_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time zcat /root/history_log.sql.gz | sed 's|history_log|history_log_old|' | mysql --defaults-file=/root/.my.cnf zabbix</code></pre>
Restore from sql.lz4<pre><code>time unlz4 /root/trends_uint.sql.lz4 | sed 's|trends_uint|trends_uint_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time unlz4 /root/history_uint.sql.lz4 | sed 's|history_uint|history_uint_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time unlz4 /root/trends.sql.lz4 | sed 's|trends|trends_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time unlz4 /root/history.sql.lz4 | sed 's|history|history_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time unlz4 /root/history_str.sql.lz4 | sed 's|history_str|history_str_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time unlz4 /root/history_text.sql.lz4 | sed 's|history_text|history_text_old|' | mysql --defaults-file=/root/.my.cnf zabbix
time unlz4 /root/history_log.sql.lz4 | sed 's|history_log|history_log_old|' | mysql --defaults-file=/root/.my.cnf zabbix</code></pre>
<p>Download this section: <a href="src/my.sh">https://aigarskadikis.github.io/src/my.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/my.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/my.sh</a></p>
</div>
<input type="radio" name="tabs" id="mysqlsh"><label for="mysqlsh">mysqlsh</label><div class="tab">
Switch to SQL mode<pre><code>\sql</code></pre>
Change global variable in order to allow MySQL work with external directories:<pre><code>set global local_infile = 'on';</code></pre>
Switch to JavaScript mode<pre><code>\js</code></pre>
Set DB name<pre><code>DBname="zabbix"</code></pre>
Set destination directory<pre><code>DBdumpath="/tmp"</code></pre>
Download schema<pre><code>util.dumpSchemas([DBname],DBdumpath+"/zabbix_schema.dump", {ddlOnly: true, threads: 8, showProgress: true});</code></pre>
Dump all<pre><code>DBname="zabbix"
DBdumpath="/tmp"
util.dumpTables(DBname, [], DBdumpath + DBname, {"all": true,"threads": 4,"bytesPerChunk": "256M"});</code></pre>
Download configuration<pre><code>util.dumpSchemas(
[DBname],
DBdumpath+"/zabbix_configuration.dump", {
excludeTables:[
DBname+".history",
DBname+".history_uint",
DBname+".history_log",
DBname+".history_text",
DBname+".history_str",
DBname+".trends",
DBname+".trends_uint"
], threads: 8, showProgress: true}
);</code></pre>
Download configuration with zstd compression<pre><code>util.dumpSchemas(
[DBname],
DBdumpath+"/zabbix_configuration.dump.zstd", {
excludeTables:[
DBname+".history",
DBname+".history_uint",
DBname+".history_log",
DBname+".history_text",
DBname+".history_str",
DBname+".trends",
DBname+".trends_uint"
], threads: 8, compression: "zstd", showProgress: true}
);</code></pre>
Download configuration with gzip compression<pre><code>util.dumpSchemas(
[DBname],
DBdumpath+"/zabbix_configuration.dump.gzip", {
excludeTables:[
DBname+".history",
DBname+".history_uint",
DBname+".history_log",
DBname+".history_text",
DBname+".history_str",
DBname+".trends",
DBname+".trends_uint"
], threads: 8, compression: "gzip", showProgress: true}
);</code></pre>
<p>Download this section: <a href="src/mysqlsh.sh">https://aigarskadikis.github.io/src/mysqlsh.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/mysqlsh.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/mysqlsh.sh</a></p>
</div>
<input type="radio" name="tabs" id="pg"><label for="pg">pg</label><div class="tab">
Extract configuration dump from old server<pre><code>pg_dump \
--dbname=DATABASE \
--host=HOST \
--username=USER \
--file=zabbix.dump \
--format=custom \
--blobs \
--verbose \
--exclude-table-data '*.history*' \
--exclude-table-data '*.trends*'</code></pre>
Restore<pre><code>pg_restore \
--dbname=DATABASE \
--host=HOST \
zabbix.dump</code></pre>
Backup individual historical table<pre><code>PGHOST=127.0.0.1 \
PGPORT=5432 \
PGUSER=postgres \
PGPASSWORD=zabbix \
psql --dbname=zabbix \
-c "COPY (SELECT * FROM history_uint) TO stdout DELIMITER ',' CSV" | \
xz > /tmp/history_uint.csv.xz</code></pre>
Restore<pre><code>psql zabbix -c "\COPY history_uint FROM PROGRAM 'xzcat /tmp/history_uint.csv.xz' DELIMITER ',' CSV"</code></pre>
<p>Download this section: <a href="src/pg.sh">https://aigarskadikis.github.io/src/pg.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/pg.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/pg.sh</a></p>
</div>
<input type="radio" name="tabs" id="sed"><label for="sed">sed</label><div class="tab">
Reinstall values which have been already customized<pre><code>sed -i 's|^CacheUpdateFrequency=.*|CacheUpdateFrequency=120|' /etc/zabbix/zabbix_server.conf && grep ^CacheUpdateFrequency /etc/zabbix/zabbix_server.conf
sed -i 's|^ValueCacheSize=.*|ValueCacheSize=768M|' /etc/zabbix/zabbix_server.conf && grep ^ValueCacheSize /etc/zabbix/zabbix_server.conf
sed -i 's|^TrendCacheSize=.*|TrendCacheSize=256M|' /etc/zabbix/zabbix_server.conf && grep ^TrendCacheSize /etc/zabbix/zabbix_server.conf
sed -i 's|^StartDiscoverers=.*|StartDiscoverers=20|' /etc/zabbix/zabbix_server.conf && grep ^StartDiscoverers /etc/zabbix/zabbix_server.conf</code></pre>
Summarize configuration file<pre><code>grep -v "^$\|#" /etc/zabbix/zabbix_server.conf | sort</code></pre>
Restart and follow log<pre><code>systemctl restart zabbix-server && tail -f /var/log/zabbix/zabbix_server.log</code></pre>
<p>Download this section: <a href="src/sed.sh">https://aigarskadikis.github.io/src/sed.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/sed.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/sed.sh</a></p>
</div>
<input type="radio" name="tabs" id="snmptrap"><label for="snmptrap">snmptrap</label><div class="tab">
Install dependencies on ubuntu 22<pre><code>apt install snmp snmptrapd libsnmp-perl snmptt snmp-mibs-downloader -y</code></pre>
Turn down 'snmpd'. This was installed to solve dependencies<pre><code>systemctl stop snmpd && systemctl disable snmpd</code></pre>
Turn down 'snmptrapd' to reconfigure service<pre><code>systemctl stop snmptrapd</code></pre>
Make a backup of old config, install new<pre><code>mv /etc/snmp/snmptrapd.conf /etc/snmp/original.snmptrapd.conf</code></pre>
Install example config to catpur SNMPv2 traps and SNMPv3 traps<pre><code>cd / && echo "/Td6WFoAAATm1rRGAgAhARwAAAAQz1jM4Cf/AhVdADKdCIYUyy9sMvNjsbbzalh2a+CieFE1VBk12M+iJ9k2na4QOO9Ofnui3QKfd3E/1VgKRwkM3Epl5SMnZfJ+Cco4JO/AyUapb6yMjEt3XsUk7BjRRaUGM0uAlufs91DZkXRkomCIZcsUZrGk8QVyxc1g+OrLpcr1Gg25NNexih87iDdzxxXIVJgzVqeurca2iV8PwHaIeBXGVdbKgnDrACTAfUmxOg07Y1YRNqNGilYXa4zP6mlr2G8L/KlkUmJf6ubOEorh1eMX1zWVeyRK1XBCx+6WKTsxTijP20A7rttOg7s/+Z7PVXRdghD91fIRWVby9K35SKcjkn1B7BUNwC4X586M6S04Pqgb+PamryiP9Ct2w7IgMiIUcCrzC4LZuRRpzbOKzLL5NbYeeM5QOxK6/PvsM1MlZwNf+5F3ubEr4eObU517xhW+bSvntYwetQTJm+5bcOTnu+HkJaVinw58QEIsCjOOtAJmqcKkrlvo2nYuobkRW64ME3nA2TdcqJ2BZQ2o5/rKwn7ZKmCKNgxffdMELcji4pRjALX1lC8g/hyEi+ysu34iA/ciq1HJVEO9ulGVAmrr9OdmqbZXWiPs7pg7Epcjr9CKQjsORS3R/3Gsf7umyWtWnCKpex48gClLRQPv2bI2WtGG6V6uXyPyBLUPiHKj6u74SAQJ/235xmovoLNuGl5bQ9DSrp0bzRi7qhc+AAAAALkbuP45VSNNAAGxBIBQAABGKqZmscRn+wIAAAAABFla" | base64 --decode | unxz | tar -xv</code></pre>
Install example config to catpur SNMPv2 traps and SNMPv3 traps fro Ubuntu 22<pre><code>cd / && echo "/Td6WFoAAATm1rRGAgAhARwAAAAQz1jM4Cf/AYNdADKdCIYUyy9sMvNjsbbzalh2a+CieFE1VBk116qSpEChzLfeNm/VMSFs0glXd1kGmtWdaahiXsCj/lmFbJdNPBKh2MwwBi9c7ONuSaWL+cEZOEGH3966HOgmoL6XtkTd0ilQ4in/LDfhRuwL4659LqCUDqASYem/P0OmvYVnLyAIIrIgRl+QwqRYQyGtU8YrjfRJMuGU4djjwWSC2Elx8WEIr1Q12VTLcNoeXeMkOaonxhmtWgZ5mzTedKf+Bydc+lnUQjCe/aDIw2CL3Z89BKaYLh7LlqqdQEEZhzQQhLkfZBx/zsjiZ4hGZFqG+/HOuJ0uKiCSeySmAoTZT/ASHBpWW391kPZsefEjx3ScD6qwVoO7aDC+1i9FnuBNeD/EvLMYhYHlBP2nn4QNd/4RiYE2CYohgf3wATTuzMkQC0PeHq5rojWkOQam7pZIPy395Rahm0fhoyrTGasibCWPNIT0MyBPE9pFOXraL1F9PYoSM+T2a/ZEb0k74EjQwEHZKlYNQAAAtCgAjNz6fkQAAZ8DgFAAABCSIOmxxGf7AgAAAAAEWVo=" | base64 --decode | unxz | tar -xv</code></pre>
Backup /etc/snmp/snmptrpad.conf<pre><code>tar --create --verbose --use-compress-program='xz -9' /etc/snmp/snmptrapd.conf | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | unxz | tar -xv%' && echo</code></pre>
Start SNMP trap listening service and enable at startup<pre><code>systemctl start snmptrapd && systemctl enable snmptrapd</code></pre>
Check if it listens on UDP 162<pre><code>ss --udp --listen --numeric --process | grep 162</code></pre>
Install official parser from git.zabbix.com<pre><code>curl https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/misc/snmptrap/zabbix_trap_receiver.pl?at=refs%2Fheads%2Fmaster -o /usr/local/bin/zabbix_trap_receiver.pl</code></pre>
Install official parser from gitgub.com<pre><code>curl https://raw.githubusercontent.com/zabbix/zabbix/master/misc/snmptrap/zabbix_trap_receiver.pl -o /usr/local/bin/zabbix_trap_receiver.pl</code></pre>
Install without internet access<pre><code>cd / && echo "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" | base64 --decode | unxz | tar -xv</code></pre>
Non-official with variable binding<pre><code>cd / && echo "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" | base64 --decode | unxz | tar -xv</code></pre>
Bash parser<pre><code>cd / && echo "/Td6WFoAAATm1rRGAgAhARwAAAAQz1jM4Cf/AiddADqcyosJgONiHFxK21FYsOmcVPjGP4X64Cl0bFy0Sxh6dQDRjk6f8dQ1bOCTQt37h4nPN7dqU5XiljBY1ISkB57iky9OaCllx2Pvw7ADF5H5hz2M/woIhS5kB6SZzGLqiZ/L4ObszSmHD/zqU/EptJXvrKiRxNPL3vREPA/bxK/iefk//ici0J76T5Pgu6B5JySWc9UrDRuOwLJH8gF+ac4z1dKxDWCbIjxuS28RZQlunU1OAlIr/CyCfBfC1Pp5b+H1lMr4yeBne7oOVqx5ytStJs+J/X+S3ck3O115oqn6NvsvaamKz6hnaSG91RKb+A8fUXoXwpXvTI8fmeOCsi9v9d1XDStnvix0EOqLqRFE9JrRiuKUHlSfkrtd1YAjr+Ab8+SpyXoxkYvt5qIsdJkT7uLhAiEcxHr2xtaZrVus3qsvA9pQ+uMtk9YIIG8auFD6ImlPI/52vUID9uBDVIv5x/1D5fhmBPRE8c9holuN9pWksYmlqewZ2deiPvfKNxpJNGp7ReBDjSh9/koaB8TWMcOKdARr52F498EGjzMeB6P7XNtUoi/gmHjgjpxDLLApKtZyENPXehKqMCUlTCKH03YuyiCezmurGbkkFAPQHKfDKSFJuahsOR/qAHOO7UwvzMluzaQFlIzUq9xpCvZjTLwpfpUnhIVxgY/GZw+9c6gweJWVUnfehDrKGqhvXFmAyjHtgTzjlpry2jgLBP72Dgt3PRLCAACEWwpFaPLuqgABwwSAUAAAjIZMILHEZ/sCAAAAAARZWg==" | base64 --decode | unxz | tar -xv</code></pre>
Send incorrect SNMPv3 engineID<pre><code>snmptrap -v 3 -n "" -a SHA -A testtest -x AES -X testtest -l authPriv -u SNMPv3username -e 0x80000634b210008894719abe07 127.0.0.1 0 1.2.3
ls /tmp</code></pre>
Send incorrect SNMPv2 community<pre><code>snmptrap -v 1 -c moon 127.0.0.1 '.1.3.6.1.6.3.1.1.5.3' '0.0.0.0' 6 33 '55' .1.3.6.1.6.3.1.1.5.3 s "eth0"
ls /tmp</code></pre>
Correct SNMPv3 engineID<pre><code>snmptrap -v 3 -n "" -a SHA -A testtest -x AES -X testtest -l authPriv -u SNMPv3username -e 0x80000634b210008894719abe08 127.0.0.1 0 1.2.3
ls /tmp
cat /tmp/zabbix_traps.tmp
rm -rf /tmp/zabbix_traps.tmp</code></pre>
Correct SNMPv2 community<pre><code>snmptrap -v 1 -c earth 127.0.0.1 '.1.3.6.1.6.3.1.1.5.3' '0.0.0.0' 6 33 '55' .1.3.6.1.6.3.1.1.5.3 s "eth0"
ls /tmp
cat /tmp/zabbix_traps.tmp
rm -rf /tmp/zabbix_traps.tmp</code></pre>
<p>Download this section: <a href="src/snmptrap.sh">https://aigarskadikis.github.io/src/snmptrap.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/snmptrap.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/snmptrap.sh</a></p>
</div>
<input type="radio" name="tabs" id="sudoers"><label for="sudoers">sudoers</label><div class="tab">
Allow to reload cache from Zabbix frontend<pre><code>cd /etc/sudoers.d
echo 'zabbix ALL=(ALL) NOPASSWD: /usr/sbin/zabbix_server -R config_cache_reload' | sudo tee zabbix_server_config_cache_reload
chmod 0440 zabbix_server_config_cache_reload</code></pre>
<p>Download this section: <a href="src/sudoers.sh">https://aigarskadikis.github.io/src/sudoers.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/sudoers.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/sudoers.sh</a></p>
</div>
<input type="radio" name="tabs" id="supply"><label for="supply">supply</label><div class="tab">
Listening TCP ports<pre><code>ss --tcp --listen --numeric</code></pre>
Listening TCP ports with process identification<pre><code>ss --tcp --listen --numeric --process</code></pre>
Ensure service is listening on UDP 162<pre><code>ss --udp --listen --numeric --process | grep 162</code></pre>
Check if tcp port listens. Make sure it really listens on destination server before checking<pre><code>nc -v servername 3306</code></pre>
Check if port is open without external tools. If it reports 0, the port is reachable and in the listening state<pre><code>{ echo >/dev/tcp/127.0.0.1/3306 ; } 2>/dev/null; echo $?</code></pre>
Capture all SNMP traps traffic<pre><code>tcpdump -i any udp dst port 162 >> /var/log/zabbix/zabbix_traps.tcpdump</code></pre>
Activity for each block device, pretty-print  device  names, report task creation and system switching activity.<pre><code>sar -d -p -w 1</code></pre>
10 seconds of disk usage<pre><code>sar -d -wp 1 10 >> /tmp/disk.activity.txt</code></pre>
Installed packages on EL7 or EL8 system<pre><code>rpm -qa > /tmp/installed.packages.txt</code></pre>
Installed packages on Ubuntu/Debian<pre><code>apt list --installed > /tmp/apt.installed.txt</code></pre>
OS information<pre><code>cat /etc/*release* > /tmp/os.info.txt</code></pre>
Disk space<pre><code>df -h > /tmp/disk.space.txt</code></pre>
OS, Memory, CPU, Disk characteristics<pre><code>cat /etc/*release* > /tmp/$(hostname).characteristics.txt
cat /proc/meminfo >> /tmp/$(hostname).characteristics.txt
free -h >> /tmp/$(hostname).characteristics.txt
cat /proc/cpuinfo >> /tmp/$(hostname).characteristics.txt
df -h >> /tmp/$(hostname).characteristics.txt</code></pre>
Usage of swap:<pre><code>for file in /proc/*/status ; do awk '/VmSwap|Name/{printf $2 " " $3}END{ print ""}' $file; done >> /tmp/$(hostname).swap.usage.txt</code></pre>
Process list. Top memory. top CPU<pre><code>ps auxww > /tmp/process.list.txt
ps auxww --sort -%mem > /tmp/top.mem.processes.txt
ps auxww --sort -%cpu > /tmp/top.cpu.processes.txt</code></pre>
Shared memory segments and semaphore arrays<pre><code>ipcs -a > /tmp/shared.memory.segments.and.semaphore.arrays.txt</code></pre>
Last 1 million lines from messages<pre><code>tail -1000000 /var/log/messages > /tmp/messages.txt</code></pre>
Display all messages from the kernel ring buffer<pre><code>dmesg > /tmp/dmesg.txt</code></pre>
Live kernel settings<pre><code>sysctl -a > /tmp/.live.kernel.settings.txt</code></pre>
Last 1 million lines from /var/log/zabbix/zabbix_proxy.log<pre><code>tail -1000000 /var/log/zabbix/zabbix_proxy.log | gzip --best > /tmp/zabbix_proxy.$(date +%Y%m%d.%H%M).log.gz</code></pre>
Last 1 million lines from /var/log/zabbix/zabbix_server.log<pre><code>tail -1000000 /var/log/zabbix/zabbix_server.log | gzip --best > /tmp/zabbix_server.$(date +%Y%m%d.%H%M).log.gz</code></pre>
All trapper processes<pre><code>watch -n1 'ps auxww | grep -Eo "[:] trapper #.*"'</code></pre>
Free trapper processes<pre><code>watch -n1 'ps auxww | grep -Eo "[:] trapper #.*waiting for connection"'</code></pre>
Service not booting up<pre><code>journalctl -u sshd | tail -100 > /tmp/sshd.txt</code></pre>
List of open files:<pre><code>lsof > /tmp/list.open.files.txt</code></pre>
Disk long term throughput, how fast we can create 64GB file<pre><code>time dd if=/dev/urandom of=/var/lib/mysql/64GB.file bs=1M count=65536 oflag=direct</code></pre>
<p>Download this section: <a href="src/supply.sh">https://aigarskadikis.github.io/src/supply.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/supply.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/supply.sh</a></p>
</div>
<input type="radio" name="tabs" id="web"><label for="web">web</label><div class="tab">
Zabbix 6.0 frontend module to hide "Templates" column under "Configuration" => "Hosts"<pre><code>cd / && echo "/Td6WFoAAATm1rRGAgAhARwAAAAQz1jM4Cf/BIhdADqcyosJxdxJssUvYbZwczCa4NL6WKTOtRi0c554WcmBrkKJ0mJAeAaic7i991X+PJKgUTuAnCLyHef+BXOL1bHqkaZZZr4lBVY4be1LihI2ek87Yq0PoxsOmTJvtFLvNkQuXDQEwdAqs4FwSYnDJRsbo8LnCmjlRabqLk15axqJS9ccv9L4lAHtEWnvKA66Boc2njRgpyJXQUNhKfStLJlmV1gwGUBCH0Iq6bgCAp1B4hCtc7Xc6RdYDfBSEweI7oB7vSaq0PZhm3+Q7MJmw5HO4MGcUZpmeSHcvVQfnaX0AXb7OHtl6QkKs4YOdjqEDxrJ0AlQcs5ikDS8FfVYQPnVXYN0T92UMgNY+24lnNDq5fDw9yOHKvpoOM4hARy3RgSzD3rL+VHGtL5yXmORxrYWGBD0PooiX8hKTPnoQop47TmDrrShiQjSNcio30nj0Tti/MtDClNlSEaboMa1EGjcnNH7Ga4btSeGvbeY3hqTym4HHoU6JFldBtIEPFvCL1SHxSkVL8CBPapJCgmiev1aPK5VGl46hocWHfZ0GSRSf61ykDoITplZ2XU+j6/Vz4zkLh6iLeDV2ts1al+9SiL7fB2kT8LQAD7yOBAsIUzhQ2k5WH6Aa4q6XwDHfK+d63IcsYgKJoNP7qGySE9HrOcYeoWbtymprkltzXAbuRFEZqNxeqBXLPt1DM3Bd+F/QyQrDEA/nsxg+EJ6sLcnFnLDrlYxjSCxkh8KFZZHn1arIz/n1A+4yBOkE8f1f/BidwtLBOGAb7L0ngnm6VtlEw7EApeSPUvahjZXDPf9pfZSbyuLWfb9twZmEzCEa3tUvrLEa6FDibEQtzXmDNEWJIg4NIlw+MW56igfQ0c3pkxo/l78UpL+VborSVzdI46H3IKxY6bF7t9bk6IMiikie60tZbQGxeYVrxYmKdc7FXI8MehxOkOAP7+xL4XgFYCed1vfhxu3/FAKlgiA0ITGTUzXJa+bzEs4tyWPligj3KL1tUaH9UqxDgT8uH99O9jMduja1ZaR6WadsisLXgZ3XNgGwYfbtNZfXqk6ggfOjJCLznozMugf1NiDGUVVIIRCV6esaCrcDRVU06YlOY9SmJsFuC8fApi3ul8qljMMoZHonjshOc03QmaC75XmX26xloDmK8ygeiLGzO4MWHd1REQlhavsxADSLcNM5K/riurHH4+H7MvMMrwlk7e/H6dIiQJQxSzw2kSpprUM70jwoQKRgbthQdWIGyjRmf7BOzs9gdgJ4QVqSAkhvfWIFRTLZVjvpxURMqL2Rp5X4ankwEyAhbvx0mAlWLDv2jpB3MBdBwQbIwODrTZCGPKlBcax+azw5MmGGWFEK0UMeW2w0BvJpjTP6504r/NuKU9SRlZCHC9oykwCT23x1teLxQFo3EGkdVE+AGolBqi3OxNtdUJNMvpbR3La/JetE3JGzjUVp36bwnHcddVKJhmSdeKgIXcwVJWJ+8vCeg2A9EKocxq1QMJliVymitvrnLAxBX21VYmRtto/E00MeOzrQoqoI5RHs832OyUAAPnXuYqgJ3MuAAGkCYBQAADffS3NscRn+wIAAAAABFla" | base64 --decode | unxz | tar -xv</code></pre>
On EL8 system allow NGINX to server Zabbix GUI under 127.0.0.1:80. This is useful for Zabbix API<pre><code>cd / && echo "H4sIANj39GICA+2VQU/iQBTHOfMpeuCAMdspbEGzxANRVk0UXKgHIzqp7RQmlpnuzNQFF/3sO61QQbDVi8km70fCZDLv/3/T6XtTojzERpRNkcdZYPporFRk1up7pqV/NTPgwnx07+7o1HQjaiZBpc9iaZq2lY6at+P3ZrNRqtn1vUbNbjRsu2TVrbrdLBlW6QuIpXKFYZQE5yovrmj9P0US8UCE8bdsLAipVIQZGftWK1t7CcbMnZB0npVJq1zOgpKDSkYUS4Hk2BUEvRRQ6zWGMp9Ml6MZjaOVtZB7rqKcGQcGCtwHqkvO1H8rW3yNHGHGFQ54zHw950HwutenLY5oi4kSMxzQkMjFvBILmv4h48C27AJDV0qi5BZb1/OIlFhv8WW+trclZBpRkWXW52n5+fmeDTQ0x2pLPp+w2Vr+MCy0quqOHqJ50tPXt0PzZk6ZF8Y+mSdBIdn5bJqsAoiKxUoJFR/jA2E+F1+W79m4vkU3w6Twqmhe2faggSuVN6I40m84mceMTn8gETOkRd+CaLIoalNy7771rlxGIVXaRI0xZQE3bqvmbpp3p4rM3Z3K+8q8FtncpHAnen7UO7w873Qd3O/1nO0tWGQxOOyfXjj45+lZp9s+72xaVLJH8wSNVHoZFNtetJ0T7PTb3cFZ2+kcfdR2w3dRoev+sjj/r8tO/woPnP5p9zjt8t8x0Y0vlaBsVCzvd7TBwMHnHeekd6TlgmgDqfCEqDH3iw0Oe10neTHO1UUnza+bTl+zCqtZRD4u1y/l2DlZkYeEjdQ4pzSojhMe0SdKhOAiu2s4yym9EeOCYC+kSQr3jgv1/h22FOkdMeLpB6ITwmOVrTetnO7Qbb8hSO7B/RyRIO7nRXdxEOgvl6SPZG29Vt+/L1LJt8uGbdQbzVydnC3FqznzVYpMovRThP8IqkgmXFc9lZ/KJQAAAAAAAAAAAAAAAAAAAAAAAAAAAABY5x8NJf5GACgAAA==" | base64 --decode | gunzip | tar -xv
nginx -t
systemctl reload nginx</code></pre>
<p>Download this section: <a href="src/web.sh">https://aigarskadikis.github.io/src/web.sh</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/web.sh" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/web.sh</a></p>
</div>
<input type="radio" name="tabs" id="delete"><label for="delete">delete.sql</label><div class="tab">
Discard all users which is using frontend. Zabbix 3.0, 3.2, 3.4, 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>DELETE FROM session;</code></pre>
Delete all events comming from specific trigger id. Zabbix 4.0, 5.0<pre><code>DELETE
FROM events
WHERE events.source=0
AND events.object=0
AND events.objectid=987654321;</code></pre>
Delete discovery, autoregistration and internal events<pre><code>DELETE FROM events WHERE source IN (1,2,3) LIMIT 1;
DELETE FROM events WHERE source IN (1,2,3) LIMIT 10;
DELETE FROM events WHERE source IN (1,2,3) LIMIT 100;</code></pre>
Delete child events which was closed by global correlation. Zabbix 5.0<pre><code>DELETE e
FROM events e
LEFT JOIN event_recovery ON (event_recovery.eventid=e.eventid)
WHERE event_recovery.c_eventid IS NOT NULL
AND e.clock < 1234;</code></pre>
Delete dublicate values per itemid. Zabbix 5.0<pre><code>DELETE t1
FROM history_text t1
INNER JOIN history_text t2
WHERE t1.itemid=382198
AND t1.clock < t2.clock
AND t1.value=t2.value
AND t1.itemid=t2.itemid;</code></pre>
Remove evidence about all failed actions. Zabbix 5.0<pre><code>DELETE FROM alerts WHERE status=2;</code></pre>
Delete all dublicate metrics in history_text. Zabbix 5.0<pre><code>DELETE t1
FROM history_text t1
INNER JOIN history_text t2
WHERE t1.clock < t2.clock
AND t1.value=t2.value
AND t1.itemid=t2.itemid;</code></pre>
Delete all dublicate metrics in history. Zabbix 5.0<pre><code>DELETE t1
FROM history_str t1
INNER JOIN history_str t2
WHERE t1.clock < t2.clock
AND t1.value=t2.value
AND t1.itemid=t2.itemid;</code></pre>
Remove data for 'history_text' where 'Do not keep history'. Zabbix 5.0<pre><code>DELETE
FROM history_text WHERE itemid IN (
SELECT items.itemid FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status IN (0,1)
AND items.value_type=4
AND items.flags IN (0,4)
AND items.history IN ('0')
);</code></pre>
Remove data for 'history_str' where 'Do not keep history'. Zabbix 5.0<pre><code>DELETE FROM history_str WHERE itemid IN (
SELECT items.itemid FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status IN (0,1)
AND items.value_type=1
AND items.flags IN (0,4)
AND items.history IN ('0')
);</code></pre>
Scan 'history_text' table and accidentally stored integers, decimal numbers, log entries and short strings. Zabbix 3.0, 3.2, 3.4, 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>DELETE FROM history_text WHERE itemid NOT IN (SELECT itemid FROM items WHERE value_type=4);
DELETE FROM history_text WHERE itemid IN (SELECT itemid FROM items WHERE value_type<>4);</code></pre>
Scan 'history_str' table and accidentally stored integers, decimal numbers, log entries and long text strings. Zabbix 3.0, 3.2, 3.4, 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>DELETE FROM history_str WHERE itemid NOT IN (SELECT itemid FROM items WHERE value_type=1);
DELETE FROM history_str WHERE itemid IN (SELECT itemid FROM items WHERE value_type<>1);</code></pre>
Remove repeated values per one itemid in 'history_str'. Discard unchanded. Zabbix 5.0, 6.0<pre><code>DELETE FROM history_str WHERE itemid=343812 AND clock IN (
SELECT clock FROM (
SELECT clock, value, r, v2 FROM (
SELECT clock, value, LEAD(value,1) OVER (order by clock) AS v2,
CASE
WHEN value <> LEAD(value,1) OVER (order by clock)
THEN value
ELSE 'zero'
END AS r
FROM history_str WHERE itemid=343812
) x2
WHERE r='zero'
) x3
WHERE v2 IS NOT NULL
);</code></pre>
Remove repeated values per one itemid in 'history_text'. Discard unchanded. Zabbix 5.0, 6.0<pre><code>DELETE FROM history_text WHERE itemid=42702 AND clock IN (
SELECT clock from (
SELECT clock, value, r, v2 FROM (
SELECT clock, value, LEAD(value,1) OVER (order by clock) AS v2,
CASE
WHEN value <> LEAD(value,1) OVER (order by clock)
THEN value
ELSE 'zero'
END AS r
FROM history_text WHERE itemid=42702
) x2
WHERE r='zero'
) x3
WHERE v2 IS NOT NULL
);</code></pre>
<p>Download this section: <a href="src/delete.sql">https://aigarskadikis.github.io/src/delete.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/delete.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/delete.sql</a></p>
</div>
<input type="radio" name="tabs" id="mysql"><label for="mysql">mysql.sql</label><div class="tab">
Ssl connection information for MySQL<pre><code>SELECT sbt.variable_value AS tls_version, t2.variable_value AS cipher,
processlist_user AS user, processlist_host AS host
FROM performance_schema.status_by_thread AS sbt
JOIN performance_schema.threads AS t ON t.thread_id = sbt.thread_id
JOIN performance_schema.status_by_thread AS t2 ON t2.thread_id = t.thread_id
WHERE sbt.variable_name = 'Ssl_version' and t2.variable_name = 'Ssl_cipher' ORDER BY tls_version;</code></pre>
Persistent connections<pre><code>SELECT * FROM information_schema.processlist WHERE command = 'Sleep';</code></pre>
Create random password for users<pre><code>UPDATE users SET passwd=substring(MD5(RAND()),1,20) WHERE userid NOT IN (1);</code></pre>
Busy connections<pre><code>SELECT * FROM information_schema.processlist WHERE command != 'Sleep' and time > 1 and user != 'event_scheduler' ORDER BY time DESC, id;</code></pre>
Mimic SHOW SLAVE STATUS<pre><code>SELECT t.PROCESSLIST_TIME, t.* FROM performance_schema.threads t WHERE NAME IN('thread/sql/slave_io', 'thread/sql/slave_sql');
SELECT t.PROCESSLIST_TIME, t.* FROM performance_schema.threads t;</code></pre>
<p>Download this section: <a href="src/mysql.sql">https://aigarskadikis.github.io/src/mysql.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/mysql.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/mysql.sql</a></p>
</div>
<input type="radio" name="tabs" id="part"><label for="part">part.sql</label><div class="tab">
Swap tables. This will allow to see oldest data. but the most recent data will be missing<pre><code>RENAME TABLE history TO history_tmp; RENAME TABLE history_old TO history;
RENAME TABLE history_uint TO history_uint_tmp; RENAME TABLE history_uint_old TO history_uint;
RENAME TABLE history_str TO history_str_tmp; RENAME TABLE history_str_old TO history_str;
RENAME TABLE history_log TO history_log_tmp; RENAME TABLE history_log_old TO history_log;
RENAME TABLE history_text TO history_text_tmp; RENAME TABLE history_text_old TO history_text;
RENAME TABLE trends TO trends_tmp; RENAME TABLE trends_old TO trends;
RENAME TABLE trends_uint TO trends_uint_tmp; RENAME TABLE trends_uint_old TO trends_uint;</code></pre>
Restore back most recent data<pre><code>INSERT IGNORE INTO history SELECT * FROM history_tmp;
INSERT IGNORE INTO history_uint SELECT * FROM history_uint_tmp;
INSERT IGNORE INTO history_str SELECT * FROM history_str_tmp;
INSERT IGNORE INTO history_log SELECT * FROM history_log_tmp;
INSERT IGNORE INTO history_text SELECT * FROM history_text_tmp;
INSERT IGNORE INTO trends SELECT * FROM trends_tmp;
INSERT IGNORE INTO trends_uint SELECT * FROM trends_uint_tmp;</code></pre>
Check all graphs, it should be completed. If graphs are perfect:<pre><code>DROP TABLE history_tmp;
DROP TABLE history_uint_tmp;
DROP TABLE history_str_tmp;
DROP TABLE history_log_tmp;
DROP TABLE history_text_tmp;
DROP TABLE trends_tmp;
DROP TABLE trends_uint_tmp;</code></pre>
<p>Download this section: <a href="src/part.sql">https://aigarskadikis.github.io/src/part.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/part.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/part.sql</a></p>
</div>
<input type="radio" name="tabs" id="proxy"><label for="proxy">proxy.sql</label><div class="tab">
How many values is in the backlog. Does not work on oracle proxy becuase of LIMIT. Zabbix 4.0, 5.0, 6.0<pre><code>SELECT MAX(id)-(SELECT nextid FROM ids WHERE table_name="proxy_history" LIMIT 1)
FROM proxy_history;</code></pre>
Skip all cached LLD rules<pre><code>delete from proxy_history where itemid in (select itemid from items where flags=1);</code></pre>
Delete data which has been sent already<pre><code>DELETE FROM proxy_history WHERE id < (select nextid from ids where table_name = "proxy_history" limit 1);</code></pre>
Show LLD JSON data<pre><code>SELECT items.hostid, items.hostid, items.key_, proxy_history.value FROM proxy_history, items WHERE proxy_history.itemid=items.itemid AND items.flags=1 ORDER BY clock ASC;</code></pre>
Optimal query to identify data overload. Zabbix 4.0, 5.0, 6.0<pre><code>SELECT itemid,
COUNT(*),
AVG(LENGTH(value))
FROM proxy_history
WHERE proxy_history.clock > UNIX_TIMESTAMP(NOW()-INTERVAL 1 HOUR)
GROUP BY 1 ORDER BY 2,3 DESC;</code></pre>
Proxy with MySQL. Print URLs for latest data page for the incomming big data. Zabbix 4.0, 5.0, 6.0<pre><code>SELECT
LENGTH(value),
CONCAT('history.php?itemids%5B0%5D=', proxy_history.itemid,'&action=showlatest') AS 'URL'
FROM proxy_history
JOIN items ON (items.itemid=proxy_history.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE LENGTH(value) > 60000;</code></pre>
Check big LLD rules and its frequency based on clock. Zabbix 4.0, 5.0, 6.0<pre><code>SELECT
clock,
hosts.host,
items.key_,
LENGTH(value)
FROM proxy_history
JOIN items ON (items.itemid=proxy_history.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE items.flags=1
AND LENGTH(value) > 6000;</code></pre>
LLD rules. Zabbix 4.0, 5.0, 6.0<pre><code>SELECT
items.key_,
COUNT(*),
AVG(LENGTH(value))
FROM proxy_history, items
WHERE proxy_history.itemid=items.itemid
AND items.flags=1
GROUP BY 1 ORDER BY 3,2;</code></pre>
<p>Download this section: <a href="src/proxy.sql">https://aigarskadikis.github.io/src/proxy.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/proxy.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/proxy.sql</a></p>
</div>
<input type="radio" name="tabs" id="server" checked="checked"><label for="server">server.sql</label><div class="tab">
How many user groups has debug mode 1. Zabbix 5.0, 5.2<pre><code>SELECT COUNT(*) FROM usrgrp WHERE debug_mode=1;</code></pre>
Active problems including internal. Zabbix 4.0, 5.0, 6.0, 6.2<pre><code>SELECT COUNT(*), source, object, severity FROM problem GROUP BY 2,3,4 ORDER BY severity;</code></pre>
Query host and interface details. Zabbix 5.0<pre><code>SELECT proxy.host AS proxy, hosts.host,
hosts.hostid,
interface.interfaceid,
interface.main,
interface.type,
interface.useip,
interface.ip,
interface.dns,
interface.port,
interface_snmp.version,
interface_snmp.bulk,
interface_snmp.community,
interface_snmp.securityname,
interface_snmp.securitylevel,
interface_snmp.authpassphrase,
interface_snmp.privpassphrase,
interface_snmp.authprotocol,
interface_snmp.privprotocol,
interface_snmp.contextname
FROM hosts
LEFT JOIN interface ON (interface.hostid=hosts.hostid)
LEFT JOIN interface_snmp ON (interface.interfaceid=interface_snmp.interfaceid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status IN (0,1) AND hosts.flags=0;</code></pre>
Unreachable ZBX host. Zabbix 4.0, 4.2, 4.4, 5.0, 5.2<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
hosts.error AS hostError,
CONCAT('hosts.php?form=update&hostid=', hosts.hostid) AS goTo
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND LENGTH(hosts.error) > 0;</code></pre>
Unreachable SNMP hosts. Zabbix 4.0, 4.2, 4.4, 5.0, 5.2<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
hosts.snmp_error AS hostError,
CONCAT('hosts.php?form=update&hostid=', hosts.hostid) AS goTo
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND LENGTH(hosts.snmp_error) > 0;</code></pre>
Dublicate devices phase1. Find duplicate interfaces based on device serial number stored in the "Serial A" field<pre><code>SELECT host_inventory.serialno_a AS serial, GROUP_CONCAT(interface.interfaceid) AS iID
FROM interface, host_inventory, hosts
WHERE host_inventory.hostid=interface.hostid
AND hosts.hostid=host_inventory.hostid
AND hosts.status=0
AND interface.main=0
AND host_inventory.serialno_a='123456'
GROUP BY host_inventory.serialno_a;</code></pre>
Same host name<pre><code>SELECT host_inventory.name AS name, GROUP_CONCAT(interface.interfaceid) AS IP, GROUP_CONCAT(hosts.hostid) AS hID
FROM interface, host_inventory, hosts
WHERE host_inventory.hostid=interface.hostid
AND hosts.hostid=host_inventory.hostid
AND hosts.status=0
AND interface.main=0
AND host_inventory.name='idrac'
GROUP BY 1;</code></pre>
Dublicate devices phase2. Add the interface to the other device<pre><code>UPDATE interface SET hostid=10561 WHERE interfaceid IN (28,32,437);</code></pre>
Dublicate devices phase3. Summary<pre><code>SELECT host_inventory.serialno_a AS serial, GROUP_CONCAT(interface.ip) AS IP, GROUP_CONCAT(hosts.hostid) AS hID
FROM interface, host_inventory, hosts
WHERE host_inventory.hostid=interface.hostid
AND hosts.hostid=host_inventory.hostid
AND hosts.status=0
AND LENGTH(host_inventory.serialno_a) > 0
GROUP BY host_inventory.serialno_a
HAVING COUNT(*) > 1;</code></pre>
Order how hosts got discovered. Must have global setting on to keep older records. Zabbix 6.0<pre><code>SELECT FROM_UNIXTIME(clock), name,
CASE value
WHEN 0 THEN 'UP'
WHEN 1 THEN 'DOWN'
WHEN 2 THEN 'discovered'
WHEN 3 THEN 'lost'
END AS "status"
FROM events
WHERE source=1
AND value=2
ORDER BY 1 ASC;</code></pre>
Go directly per unsupported items per host object. Zabbix 6.0<pre><code>SELECT COUNT(*),proxy.host, hosts.host, CONCAT('items.php?context=host&filter_hostids%5B%5D=',hosts.hostid,'&filter_name=&filter_key=&filter_type=-1&filter_value_type=-1&filter_snmp_oid=&filter_history=&filter_trends=&filter_delay=&filter_evaltype=0&filter_tags%5B0%5D%5Btag%5D=&filter_tags%5B0%5D%5Boperator%5D=0&filter_tags%5B0%5D%5Bvalue%5D=&filter_state=1&filter_with_triggers=-1&filter_inherited=-1&filter_discovered=-1&filter_set=1') AS hostid
FROM items
JOIN item_rtdata ON (item_rtdata.itemid=items.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND item_rtdata.state=1
GROUP BY 2,3,4
ORDER BY 1 DESC
LIMIT 10;</code></pre>
All items which belongs to application 'DR'. Zabbix 5.0<pre><code>SELECT hosts.host, items.key_
FROM items, hosts, items_applications, applications
WHERE items_applications.itemid=items.itemid
AND applications.applicationid=items_applications.applicationid
AND hosts.hostid=items.hostid
AND hosts.status=0
AND items.status=0
AND items.flags IN (0,4)
AND applications.name='DR';</code></pre>
Clean up trends for items which now does not want to store trends or item is disabled. Zabbix 5.0<pre><code>SET SESSION SQL_LOG_BIN=0;
DELETE FROM trends WHERE itemid IN (SELECT itemid FROM items WHERE value_type=0 AND trends='0' AND flags IN (0,4));
DELETE FROM trends WHERE itemid IN (SELECT itemid FROM items WHERE value_type=0 AND status=1 AND flags IN (0,4));
DELETE FROM trends_uint WHERE itemid IN (SELECT itemid FROM items WHERE value_type=3 AND trends='0' AND flags IN (0,4));
DELETE FROM trends_uint WHERE itemid IN (SELECT itemid FROM items WHERE value_type=3 AND status=1 AND flags IN (0,4));
DELETE FROM history_text WHERE itemid IN (SELECT itemid FROM items WHERE value_type=4 AND history='0' AND flags IN (0,4));
DELETE FROM history_text WHERE itemid IN (SELECT itemid FROM items WHERE value_type=4 AND status=1 AND flags IN (0,4));
DELETE FROM history_str WHERE itemid IN (SELECT itemid FROM items WHERE value_type=1 AND history='0' AND flags IN (0,4));
DELETE FROM history_str WHERE itemid IN (SELECT itemid FROM items WHERE value_type=1 AND status=1 AND flags IN (0,4));
DELETE FROM history_log WHERE itemid IN (SELECT itemid FROM items WHERE value_type=2 AND history='0' AND flags IN (0,4));
DELETE FROM history_log WHERE itemid IN (SELECT itemid FROM items WHERE value_type=2 AND status=1 AND flags IN (0,4));</code></pre>
List LLD rules which has an "input" from "Zabbix trapper" item. This is list on what will be about to be disabled.<pre><code>SELECT hosts.host AS host, master_itemid.key_ AS master, items.key_ AS LLD
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN items master_itemid ON (master_itemid.itemid=items.master_itemid)
WHERE items.flags=1
AND hosts.status=0
AND master_itemid.type=2;</code></pre>
Note down exact itemIDs for LLD items which is attached to "Zabbix trapper" item:<pre><code>SET SESSION group_concat_max_len = 1000000; SELECT GROUP_CONCAT(items.itemid)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN items master_itemid ON (master_itemid.itemid=items.master_itemid)
WHERE items.flags=1
AND hosts.status=0
AND master_itemid.type=2;</code></pre>
Dependency tree for active problems. Zabbix 6.0<pre><code>SELECT triggerid_down, COUNT(*) FROM trigger_depends WHERE triggerid_up IN (SELECT objectid FROM problem WHERE source=0) GROUP BY 1 HAVING COUNT(*)>1 ORDER BY 2 DESC LIMIT 10;
SELECT triggerid_down, COUNT(*) FROM trigger_depends WHERE triggerid_down IN (SELECT objectid FROM problem WHERE source=0) GROUP BY 1 HAVING COUNT(*)>1 ORDER BY 2 DESC LIMIT 10;
SELECT triggerid_up, COUNT(*) FROM trigger_depends WHERE triggerid_down IN (SELECT objectid FROM problem WHERE source=0) GROUP BY 1 HAVING COUNT(*)>1 ORDER BY 2 DESC LIMIT 10;
SELECT triggerid_up, COUNT(*) FROM trigger_depends WHERE triggerid_up IN (SELECT objectid FROM problem WHERE source=0) GROUP BY 1 HAVING COUNT(*)>1 ORDER BY 2 DESC LIMIT 10;</code></pre>
Usernames, roles and user type. Zabbix 6.0<pre><code>SELECT
users.username,
role.name AS Role,
CASE role.type
WHEN 1 THEN 'user'
WHEN 2 THEN 'admin'
WHEN 3 THEN 'super admin'
END AS UserType
FROM users
JOIN role ON (users.roleid=role.roleid);</code></pre>
Active and disabled hosts and items. Zabbix 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0<pre><code>SELECT
proxy.host AS proxy,
CASE hosts.status
WHEN 0 THEN 'Active'
WHEN 1 THEN 'Disabled'
END AS host,
CASE items.status
WHEN 0 THEN 'Active'
WHEN 1 THEN 'Disabled'
END AS item,
CASE items.type
WHEN 0 THEN 'Zabbix agent'
WHEN 1 THEN 'SNMPv1 agent'
WHEN 2 THEN 'Zabbix trapper'
WHEN 3 THEN 'Simple check'
WHEN 4 THEN 'SNMPv2 agent'
WHEN 5 THEN 'Zabbix internal'
WHEN 6 THEN 'SNMPv3 agent'
WHEN 7 THEN 'Zabbix agent (active) check'
WHEN 8 THEN 'Aggregate'
WHEN 9 THEN 'HTTP test (web monitoring scenario step)'
WHEN 10 THEN 'External check'
WHEN 11 THEN 'Database monitor'
WHEN 12 THEN 'IPMI agent'
WHEN 13 THEN 'SSH agent'
WHEN 14 THEN 'TELNET agent'
WHEN 15 THEN 'Calculated'
WHEN 16 THEN 'JMX agent'
WHEN 17 THEN 'SNMP trap'
WHEN 18 THEN 'Dependent item'
WHEN 19 THEN 'HTTP agent'
WHEN 20 THEN 'SNMP agent'
WHEN 21 THEN 'Script item'
END AS type,
COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status IN (0,1) AND items.status IN (0,1)
GROUP BY proxy.host, items.type
ORDER BY 1,2,3,4,5 DESC;</code></pre>
Most recent data collector items. Zabbix 4.2, 4.4, 5.0<pre><code>SELECT proxy.host AS proxy, hosts.host, items.itemid, items.key_
FROM items, hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.hostid=items.hostid
ORDER BY items.itemid DESC
LIMIT 10;</code></pre>
Most recent triggers<pre><code>SELECT DISTINCT triggers.triggerid, triggers.description, hosts.host, proxy.host AS proxy
FROM triggers
JOIN functions ON (functions.triggerid=triggers.triggerid)
JOIN items ON (items.itemid=functions.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE triggers.flags IN (0,4)
ORDER BY triggers.triggerid DESC
LIMIT 10;</code></pre>
ZBX hosts unreachable. Zabbix 6.0<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
interface.error,
CONCAT('zabbix.php?action=host.edit&hostid=', hosts.hostid) AS goTo
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
JOIN interface ON (interface.hostid=hosts.hostid)
WHERE LENGTH(interface.error) > 0
AND interface.type=1;</code></pre>
SNMP hosts unreachable. Zabbix 6.0<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
interface.error,
CONCAT('zabbix.php?action=host.edit&hostid=', hosts.hostid) AS goTo
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
JOIN interface ON (interface.hostid=hosts.hostid)
WHERE LENGTH(interface.error) > 0
AND interface.type=2;</code></pre>
Non-working external scripts. Zabbix 5.4, 6.0, 6.2<pre><code>SELECT
hosts.host,
items.key_,
item_rtdata.error
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN item_rtdata ON (items.itemid=item_rtdata.itemid)
WHERE hosts.status=0
AND items.status=0
AND items.type=10
AND LENGTH(item_rtdata.error) > 0;</code></pre>
Check native HA heartbeat. Zabbix 6.0, 6.2<pre><code>SELECT * FROM ha_node;</code></pre>
Count of events. All version of Zabbix<pre><code>SELECT COUNT(*),source FROM events GROUP BY source;</code></pre>
Show items by proxy. Zabbix 3.0, 3.2, 3.4, 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>SELECT
COUNT(*) AS count,
proxy.host AS proxy,
items.type
FROM items
JOIN hosts ON (items.hostid=hosts.hostid)
JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND items.status=0
AND proxy.status IN (5,6)
GROUP BY 2,3
ORDER BY 2,3;</code></pre>
Which internal event is spamming database. Zabbix 4.0, 5.0<pre><code>SELECT
CASE object
WHEN 0 THEN 'Trigger expression'
WHEN 4 THEN 'Data collection'
WHEN 5 THEN 'LLD rule'
END AS object,
objectid,
value,
name,
COUNT(*)
FROM events
WHERE source=3
AND LENGTH(name) > 0
AND clock > UNIX_TIMESTAMP(NOW()-INTERVAL 10 DAY)
GROUP BY 1,2,3,4 ORDER BY 5 DESC LIMIT 20;</code></pre>
Nested objects and macro overrides. Zabbix 5.0, 6.0<pre><code>SELECT
hm1.macro AS Macro,
child.host AS owner,
hm2.value AS defaultValue,
parent.host AS OverrideInstalled,
hm1.value AS OverrideValue
FROM hosts parent, hosts child, hosts_templates rel, hostmacro hm1, hostmacro hm2
WHERE parent.hostid=rel.hostid
AND child.hostid=rel.templateid
AND hm1.hostid=parent.hostid
AND hm2.hostid=child.hostid
AND hm1.macro=hm2.macro
AND parent.flags=0
AND child.flags=0
AND hm1.value <> hm2.value;</code></pre>
Difference between template macro and host macro. Zabbix 5.0, 6.0<pre><code>SELECT
b.host,
hm2.macro,
hm2.value AS templateValue,
h.host,
hm1.macro,
hm1.value AS hostValue
FROM hosts_templates, hosts h, hosts b, hostmacro hm1, hostmacro hm2, interface
WHERE hosts_templates.hostid=h.hostid
AND hosts_templates.templateid=b.hostid
AND interface.hostid=h.hostid
AND hm1.hostid=h.hostid
AND hm2.hostid=hosts_templates.templateid
AND hm1.macro=hm2.macro
AND hm1.value <> hm2.value;</code></pre>
Devices and it's status. Zabbix 3.0, 3.2, 3.4, 4.0, 4.2, 4.4, 5.0, 5.2<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
interface.ip,
interface.dns,
interface.useip,
CASE hosts.available
WHEN 0 THEN 'unknown'
WHEN 1 THEN 'available'
WHEN 2 THEN 'down'
END AS "status",
CASE interface.type
WHEN 1 THEN 'ZBX'
WHEN 2 THEN 'SNMP'
WHEN 3 THEN 'IPMI'
WHEN 4 THEN 'JMX'
END AS "type", hosts.error
FROM hosts
JOIN interface ON interface.hostid=hosts.hostid
LEFT JOIN hosts proxy ON hosts.proxy_hostid=proxy.hostid
WHERE hosts.status=0
AND interface.main=1;</code></pre>
Items in use. Zabbix 3.0, 3.2, 3.4, 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>SELECT
CASE items.type
WHEN 0 THEN 'Zabbix agent'
WHEN 1 THEN 'SNMPv1 agent'
WHEN 2 THEN 'Zabbix trapper'
WHEN 3 THEN 'Simple check'
WHEN 4 THEN 'SNMPv2 agent'
WHEN 5 THEN 'Zabbix internal'
WHEN 6 THEN 'SNMPv3 agent'
WHEN 7 THEN 'Zabbix agent (active) check'
WHEN 8 THEN 'Aggregate'
WHEN 9 THEN 'HTTP test (web monitoring scenario step)'
WHEN 10 THEN 'External check'
WHEN 11 THEN 'Database monitor'
WHEN 12 THEN 'IPMI agent'
WHEN 13 THEN 'SSH agent'
WHEN 14 THEN 'TELNET agent'
WHEN 15 THEN 'Calculated'
WHEN 16 THEN 'JMX agent'
WHEN 17 THEN 'SNMP trap'
WHEN 18 THEN 'Dependent item'
WHEN 19 THEN 'HTTP agent'
WHEN 20 THEN 'SNMP agent'
WHEN 21 THEN 'Script item'
END AS type,
COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND items.status=0
GROUP BY items.type
ORDER BY COUNT(*) DESC;</code></pre>
Enabled items behind proxy on enabled hosts<pre><code>SELECT
proxy.host AS proxy,
CASE items.type
WHEN 0 THEN 'Zabbix agent'
WHEN 1 THEN 'SNMPv1 agent'
WHEN 2 THEN 'Zabbix trapper'
WHEN 3 THEN 'Simple check'
WHEN 4 THEN 'SNMPv2 agent'
WHEN 5 THEN 'Zabbix internal'
WHEN 6 THEN 'SNMPv3 agent'
WHEN 7 THEN 'Zabbix agent (active) check'
WHEN 8 THEN 'Aggregate'
WHEN 9 THEN 'HTTP test (web monitoring scenario step)'
WHEN 10 THEN 'External check'
WHEN 11 THEN 'Database monitor'
WHEN 12 THEN 'IPMI agent'
WHEN 13 THEN 'SSH agent'
WHEN 14 THEN 'TELNET agent'
WHEN 15 THEN 'Calculated'
WHEN 16 THEN 'JMX agent'
WHEN 17 THEN 'SNMP trap'
WHEN 18 THEN 'Dependent item'
WHEN 19 THEN 'HTTP agent'
WHEN 20 THEN 'SNMP agent'
WHEN 21 THEN 'Script item'
END AS type,
COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND items.status=0
GROUP BY proxy.host, items.type
ORDER BY 1,2,3 DESC;</code></pre>
Exceptions in update interval. Zabbix 5.0<pre><code>SELECT
h1.host AS exceptionInstalled,
i1.name,
i1.key_,
i1.delay,
h2.host AS differesFromTemplate,
i2.name,
i2.key_,
i2.delay AS delay
FROM items i1
JOIN items i2 ON (i2.itemid=i1.templateid)
JOIN hosts h1 ON (h1.hostid=i1.hostid)
JOIN hosts h2 ON (h2.hostid=i2.hostid)
WHERE i1.delay <> i2.delay;</code></pre>
All events closed by global correlation rule. Zabbix 4.0, 5.0, 6.0<pre><code>SELECT
repercussion.clock,
repercussion.name,
rootCause.clock,
rootCause.name AS name
FROM events repercussion
JOIN event_recovery ON (event_recovery.eventid=repercussion.eventid)
JOIN events rootCause ON (rootCause.eventid=event_recovery.c_eventid)
WHERE event_recovery.c_eventid IS NOT NULL
ORDER BY repercussion.clock ASC;</code></pre>
Delete events closed by global correlation:<pre><code>DELETE FROM events WHERE eventid IN (
SELECT
repercussion.eventid
FROM events repercussion
JOIN event_recovery ON (event_recovery.eventid=repercussion.eventid)
JOIN events rootCause ON (rootCause.eventid=event_recovery.c_eventid)
WHERE event_recovery.c_eventid IS NOT NULL
ORDER BY repercussion.clock ASC
) AND clock < 1682475866;</code></pre>
Hosts with a single template<pre><code>SELECT proxy.host AS proxy,
hosts.host,
GROUP_CONCAT(template.host SEPARATOR ', ') AS templates,
COUNT(*)
FROM hosts
JOIN hosts_templates ON (hosts_templates.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
LEFT JOIN hosts template ON (hosts_templates.templateid=template.hostid)
WHERE hosts.status IN (0,1) AND hosts.flags=0 GROUP BY 1,2 HAVING COUNT(*)=1 ORDER BY 1,3,2;</code></pre>
Print host objects which own a lonely template object<pre><code>SELECT proxy.host AS proxy,
hosts.host,
template.host AS template,
COUNT(*)
FROM hosts
JOIN hosts_templates ON (hosts_templates.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
LEFT JOIN hosts template ON (hosts_templates.templateid=template.hostid)
WHERE hosts.status IN (0,1) AND hosts.flags=0
AND template.host='write name of template here'
GROUP BY 1,2,3
HAVING COUNT(*)=1
ORDER BY 1,2;</code></pre>
Auditlog spaming database<pre><code>SELECT action, resourcetype, COUNT(*) FROM auditlog WHERE clock >= UNIX_TIMESTAMP(NOW() - INTERVAL 2 HOUR) GROUP BY 1,2 ORDER BY COUNT(*) ASC;
SELECT action, resourcetype, COUNT(*) FROM auditlog WHERE clock >= UNIX_TIMESTAMP(NOW() - INTERVAL 2 HOUR) GROUP BY 1,2 ORDER BY COUNT(*) ASC;</code></pre>
List all host and template level tags<pre><code>SELECT hosts.status, host_tag.tag, host_tag.value, COUNT(*)
FROM hosts, host_tag
WHERE hosts.hostid=host_tag.hostid
AND hosts.status IN (0,3)
AND hosts.flags=0
GROUP BY 1,2,3
ORDER BY 4 DESC LIMIT 30;</code></pre>
Statistics about media types and delivery. Zabbix 4.0<pre><code>SELECT actions.name AS actionName, users.alias AS sendTo, media_type.description AS mediaName,
CASE alerts.status
WHEN 0 THEN 'NOT_SEN'
WHEN 1 THEN 'SENT'
WHEN 2 THEN 'FAILED'
WHEN 3 THEN 'NEW'
END AS "alertStatus",
COUNT(*) AS count
FROM alerts
JOIN actions ON (actions.actionid=alerts.actionid)
JOIN media_type ON (media_type.mediatypeid=alerts.mediatypeid)
LEFT JOIN users ON (users.userid=alerts.userid)
WHERE alerts.alerttype=0
GROUP BY 1,2,3,4
ORDER BY 5 ASC;</code></pre>
All active data collector items on enabled hosts. Zabbix 3.0, 4.0, 5.0, 6.0<pre><code>SELECT hosts.host, items.name, items.type, items.key_, items.delay
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND items.status=0
ORDER BY 1,2,3,4,5;</code></pre>
All recent metrics which are using units 'B'<pre><code>SELECT hosts.host AS host, items.key_ AS itemKey, items.name AS name, (history_uint.value/1024/1024/1024) AS GB
FROM history_uint
JOIN items ON (items.itemid=history_uint.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN (SELECT DISTINCT itemid AS id, MAX(history_uint.clock) AS clock
FROM history_uint
WHERE clock > UNIX_TIMESTAMP(NOW()-INTERVAL 65 MINUTE)
GROUP BY 1) t2 ON t2.id=history_uint.itemid
WHERE history_uint.clock=t2.clock
AND items.units='B'
ORDER BY 1,2;</code></pre>
All recent metrics which are using units '%'<pre><code>SELECT hosts.host AS host, items.key_ AS itemKey, items.name AS name, history.value AS percentage
FROM history
JOIN items ON (items.itemid=history.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN (SELECT DISTINCT itemid AS id, MAX(history.clock) AS clock
FROM history
WHERE clock > UNIX_TIMESTAMP(NOW()-INTERVAL 65 MINUTE)
GROUP BY 1) t2 ON t2.id=history.itemid
WHERE history.clock=t2.clock
AND items.units='%'
ORDER BY 1,2;</code></pre>
PostgreSQL. All recent metrics which are using units 'B'<pre><code>SELECT hosts.host AS host, items.key_ AS itemKey, items.name AS name, (history_uint.value/1024/1024/1024)::NUMERIC(10,2) AS GB
FROM history_uint
JOIN items ON (items.itemid=history_uint.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN (SELECT DISTINCT itemid AS id, MAX(history_uint.clock) AS clock
FROM history_uint
WHERE clock > EXTRACT(epoch FROM NOW()-INTERVAL '65 MINUTE')
GROUP BY 1) t2 ON t2.id=history_uint.itemid
WHERE history_uint.clock=t2.clock
AND items.units='B'
ORDER BY 1,2;</code></pre>
PostgreSQL. Delte sessions. Zabbix 6.0<pre><code>DELETE FROM sessions WHERE sessionid IN (SELECT sessionid FROM sessions WHERE lastaccess < EXTRACT(EPOCH FROM (NOW() - INTERVAL '1 DAY')));</code></pre>
MySQL. Delete sessions older than 1d. Zabbix 5.0, 6.0<pre><code>DELETE FROM sessions WHERE lastaccess < UNIX_TIMESTAMP(NOW()-INTERVAL 24 HOUR);</code></pre>
Which host, item is fulfiling the history_log table the most<pre><code>SELECT hosts.host, items.key_, COUNT(*)
FROM history_log
JOIN items ON (items.itemid=history_log.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE history_log.clock > UNIX_TIMESTAMP(NOW()-INTERVAL 24 HOUR)
GROUP BY 1,2
ORDER BY 3 ASC;</code></pre>
Check if different interfaces (ZBX, SNMP) used in host level<pre><code>SELECT DISTINCT hosts.host FROM interface first
JOIN interface second ON (first.hostid=second.hostid)
JOIN hosts ON (hosts.hostid=first.hostid)
WHERE first.type <> second.type;</code></pre>
List unused AND secondary interfaces. Zabbix 6.0<pre><code>SELECT hosts.host,
CASE interface.type
WHEN 0 THEN 'interface'
WHEN 1 THEN 'ZBX'
WHEN 2 THEN 'SNMP'
WHEN 3 THEN 'IPMI'
WHEN 4 THEN 'JMX'
END AS type,
interface.ip,interface.dns,interface.port
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
WHERE main=0 AND interfaceid NOT IN (SELECT DISTINCT interfaceid FROM items WHERE interfaceid IS NOT NULL);</code></pre>
List unused AND secondary interfaces. Zabbix 6.0<pre><code>DELETE FROM interface WHERE main=0 AND interfaceid NOT IN (SELECT DISTINCT interfaceid FROM items WHERE interfaceid IS NOT NULL);</code></pre>
Check if all ZBX hosts are NOT using more than one interface<pre><code>SELECT DISTINCT hosts.host, COUNT(*) AS interfaces FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
WHERE interface.type=1 AND hosts.status=0 AND hosts.flags IN (0,4)
GROUP BY 1
HAVING COUNT(*)>1;</code></pre>
Check if all SNMP hosts are NOT using more than one interface<pre><code>SELECT DISTINCT hosts.host, COUNT(*) AS interfaces FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
WHERE interface.type=2 AND hosts.status=0 AND hosts.flags IN (0,4)
GROUP BY 1
HAVING COUNT(*)>1;</code></pre>
Ratio between working and non-working JMX items. Zabbix 5.0<pre><code>SELECT
proxy.host AS proxy,
items.delay,
CASE item_rtdata.state
WHEN 0 THEN 'normal'
WHEN 1 THEN 'unsupported'
END AS state,
COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN item_rtdata ON (item_rtdata.itemid=items.itemid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE items.type=16 AND items.status=0 AND hosts.status=0
GROUP BY 1,2,3
ORDER BY 1,4,3,2 ASC;</code></pre>
PostgreSQL. All recent metrics which are using units '%'<pre><code>SELECT hosts.host AS host, items.key_ AS itemKey, items.name AS name, history.value::NUMERIC(10,2) AS percentage
FROM history
JOIN items ON (items.itemid=history.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN (SELECT DISTINCT itemid AS id, MAX(history.clock) AS clock
FROM history
WHERE clock > EXTRACT(epoch FROM NOW()-INTERVAL '65 MINUTE')
GROUP BY 1) t2 ON t2.id=history.itemid
WHERE history.clock=t2.clock
AND items.units='%'
ORDER BY 1,2;</code></pre>
Determine which items report unsupported state:<pre><code>SELECT COUNT(items.key_), hosts.host, items.key_, item_rtdata.error
FROM events
JOIN items ON (items.itemid=events.objectid)
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN item_rtdata ON (item_rtdata.itemid=items.itemid)
WHERE source=3
AND object=4
AND items.status=0
AND items.flags IN (0,1,4)
AND LENGTH(item_rtdata.error) > 0
GROUP BY hosts.host, items.key_, item_rtdata.error
ORDER BY COUNT(items.key_);</code></pre>
List all function names together with arguments<pre><code>SELECT functions.name, functions.parameter, COUNT(*)
FROM functions
JOIN items ON (items.itemid=functions.itemid)
JOIN hosts ON (items.hostid=hosts.hostid)
JOIN triggers ON (triggers.triggerid=functions.triggerid)
WHERE hosts.status=0
AND items.status=0
AND triggers.status=0
GROUP BY 1,2
ORDER BY 1;</code></pre>
Update interval of owner in case LLD rule is dependent item. Zabbix 4.0, 4.2, 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>SELECT master_itemid.key_, master_itemid.delay, COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN items master_itemid ON (master_itemid.itemid=items.master_itemid)
WHERE items.flags=1
AND hosts.status=0
AND items.status=0
AND master_itemid.status=0
AND items.type=18
GROUP BY 1,2 ORDER BY 3 DESC;</code></pre>
Frequency of LLD rule for enabled hosts and enabled items discoveries for only monitored hosts. Zabbix 4.0 => 6.2<pre><code>SELECT type,delay,COUNT(*) FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE items.flags=1 AND hosts.status=0 AND items.status=0
GROUP BY 1,2 ORDER BY 1,2;</code></pre>
Host inventory<pre><code>SELECT host_inventory.macaddress_a,GROUP_CONCAT(hosts.host) FROM host_inventory
JOIN hosts ON (hosts.hostid=host_inventory.hostid)
WHERE hosts.status=0 AND host_inventory.macaddress_a LIKE '%enterprises%'
GROUP BY host_inventory.macaddress_a;</code></pre>
Remove metrics where there are no item definition anymore<pre><code>SET SESSION SQL_LOG_BIN=0;
DELETE FROM trends WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM trends_uint WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM history_text WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM history_str WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM history_log WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM history WHERE itemid NOT IN (SELECT itemid FROM items);</code></pre>
Drop table partition in MySQL<pre><code>ALTER TABLE history_uint DROP PARTITION p2018_06_06;</code></pre>
Don't replicate transactions to the other servers in pool. Don't write to binlog<pre><code>SET SESSION SQL_LOG_BIN=0;</code></pre>
Few MySQL key settings<pre><code>SELECT
@@hostname,
@@version,
@@datadir,
@@innodb_file_per_table,
@@innodb_buffer_pool_size,
@@innodb_buffer_pool_instances,
@@innodb_flush_method,
@@innodb_log_file_size,
@@max_connections,
@@open_files_limit,
@@innodb_flush_log_at_trx_commit,
@@log_bin\G</code></pre>
Host behind proxy 'z62prx' where interface is not healthy. Host is down. Zabbix 6.2<pre><code>SELECT
hosts.host,
interface.error
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE interface.available=2
AND hosts.status=0
AND proxy.host='z62prx';</code></pre>
Host/interface errors per all hosts behind proxy. Zabbix 6.2<pre><code>SELECT
proxy.host,
hosts.host,
interface.error
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE interface.available=2
AND proxy.host IS NOT NULL
ORDER BY 1,2,3;</code></pre>
Enabled and disabled LLD items, its key. Zabbix 5.0, 5.2, 5.4, 6.0<pre><code>SELECT
items.type,
items.key_,
items.delay,
items.status,
COUNT(*) AS count
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND items.flags=1
AND hosts.status=0
GROUP BY 1,2,3,4 ORDER BY 1,2,3,4;</code></pre>
Item is not discovered anymore and will be deleted in<pre><code>SELECT
hosts.host,
items.key_
FROM items
JOIN item_discovery ON (item_discovery.itemid=items.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE item_discovery.ts_delete > 0;</code></pre>
Delete items which are not discovered anymore<pre><code>DELETE FROM items WHERE itemid IN (
SELECT x2.field FROM (
SELECT items.itemid AS field
FROM items, item_discovery, hosts
WHERE item_discovery.itemid=items.itemid
AND hosts.hostid=items.hostid
AND item_discovery.ts_delete > 0
) x2
);</code></pre>
Count of item is not discovered anymore and will be deleted<pre><code>SELECT
hosts.host,
COUNT(*) AS count
FROM items
JOIN item_discovery ON (item_discovery.itemid=items.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE item_discovery.ts_delete > 0
GROUP BY 1 ORDER BY 2 DESC LIMIT 30;</code></pre>
Which dashboard has been using host group. Zabbix 5.0,5.2<pre><code>SELECT
DISTINCT dashboard.name,
hstgrp.name
FROM widget_field
JOIN widget ON (widget.widgetid=widget_field.widgetid)
JOIN dashboard ON (dashboard.dashboardid=widget.dashboardid)
JOIN hstgrp ON (hstgrp.groupid=widget_field.value_groupid)
WHERE widget_field.value_groupid IN (2);</code></pre>
Which dashboard has been using host group id:2 for the input. Zabbix 5.4, 6.0<pre><code>SELECT
DISTINCT dashboard.name,
hstgrp.name
FROM widget_field
JOIN widget ON (widget.widgetid=widget_field.widgetid)
JOIN dashboard_page ON (dashboard_page.dashboard_pageid=widget.dashboard_pageid)
JOIN dashboard ON (dashboard.dashboardid=dashboard_page.dashboardid)
JOIN hstgrp ON (hstgrp.groupid=widget_field.value_groupid)
WHERE widget_field.value_groupid IN (2);</code></pre>
Zabbix agent auto-registration probes. Zabbix 5.0, 5.2, 5.4, 6.0<pre><code>SELECT
hosts.host AS proxy,
CASE autoreg_host.flags
WHEN 0 THEN 'IP address, do not update host interface'
WHEN 1 THEN 'IP address, update default host interface'
WHEN 2 THEN 'DNS name, update default host interface'
END AS "connect using",
CASE autoreg_host.tls_accepted
WHEN 1 THEN 'Unencrypted'
WHEN 2 THEN 'TLS with PSK'
END AS "Encryption",
COUNT(*) AS "amount of hosts"
FROM autoreg_host
JOIN hosts ON (hosts.hostid=autoreg_host.proxy_hostid)
GROUP BY 1,2,3 ORDER BY 1,2,3;</code></pre>
Items without a template. Zabbix 5.0, 6.0<pre><code>SELECT
hosts.host,
items.key_
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND hosts.flags=0
AND items.status=0
AND items.templateid IS NULL
AND items.flags=0;</code></pre>
Hosts with multiple interfaces. Zabbix 5.0, 6.0<pre><code>SELECT
hosts.host
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
WHERE hosts.flags=0
GROUP BY hosts.host
HAVING COUNT(interface.interfaceid) > 1;</code></pre>
Amount of items not discovered anymore<pre><code>SELECT
hosts.host,
COUNT(*) AS count
FROM items
JOIN item_discovery ON (item_discovery.itemid=items.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE item_discovery.ts_delete > 0
GROUP BY 1 ORDER BY 2 ASC;</code></pre>
Linked template objects PostgreSQL. Zabbix 5.0, 5.2, 5.4, 6.0<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
ARRAY_TO_STRING(ARRAY_AGG(template.host),', ') AS templates
FROM hosts
JOIN hosts_templates ON (hosts_templates.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
LEFT JOIN hosts template ON (hosts_templates.templateid=template.hostid)
WHERE hosts.status IN (0,1)
AND hosts.flags=0
GROUP BY 1,2 ORDER BY 1,3,2;</code></pre>
Linked templates objects MySQL. Zabbix 5.0, 5.2, 5.4, 6.0<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
GROUP_CONCAT(template.host SEPARATOR ', ') AS templates
FROM hosts
JOIN hosts_templates ON (hosts_templates.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
LEFT JOIN hosts template ON (hosts_templates.templateid=template.hostid)
WHERE hosts.status IN (0,1)
AND hosts.flags=0
GROUP BY 1,2 ORDER BY 1,3,2;</code></pre>
Which action is responsible. Zabbix 5.0<pre><code>SELECT
FROM_UNIXTIME(events.clock) AS 'time',
CASE events.severity
WHEN 0 THEN 'NOT_CLASSIFIED'
WHEN 1 THEN 'INFORMATION'
WHEN 2 THEN 'WARNING'
WHEN 3 THEN 'AVERAGE'
WHEN 4 THEN 'HIGH'
WHEN 5 THEN 'DISASTER'
END AS severity,
CASE events.acknowledged
WHEN 0 THEN 'NO'
WHEN 1 THEN 'YES'
END AS acknowledged,
CASE events.value
WHEN 0 THEN 'OK'
WHEN 1 THEN 'PROBLEM '
END AS trigger_status,
events.name AS 'event',
actions.name AS 'action'
FROM events
JOIN alerts ON (alerts.eventid=events.eventid)
JOIN actions ON (actions.actionid=alerts.actionid)
WHERE events.source=0
AND events.object=0
ORDER BY events.clock DESC
LIMIT 10;</code></pre>
Non-working LLD rules. Zabbix 5.0, 6.0<pre><code>SELECT
hosts.name AS hostName,
items.key_ AS itemKey,
problem.name AS LLDerror,
CONCAT('host_discovery.php?form=update&itemid=', problem.objectid) AS goTo
FROM problem
JOIN items ON (items.itemid=problem.objectid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE problem.source > 0
AND problem.object=5;</code></pre>
Non-working data collector items. Zabbix 5.0, 6.0<pre><code>SELECT
hosts.name AS hostName,
items.key_ AS itemKey,
problem.name AS DataCollectorError,
CONCAT('items.php?form=update&itemid=', problem.objectid) AS goTo
FROM problem
JOIN items ON (items.itemid=problem.objectid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE problem.source > 0
AND problem.object=4;</code></pre>
Trigger evaluation problems. Zabbix 5.0, 6.0<pre><code>SELECT
DISTINCT CONCAT('triggers.php?form=update&triggerid=', problem.objectid) AS goTo,
hosts.name AS hostName,
triggers.description AS triggerTitle,
problem.name AS TriggerEvaluationError
FROM problem
JOIN triggers ON (triggers.triggerid=problem.objectid)
JOIN functions ON (functions.triggerid=triggers.triggerid)
JOIN items ON (items.itemid=functions.itemid)
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE problem.source > 0
AND problem.object=0;</code></pre>
Loneley item<pre><code>SELECT
hosts.host,
items.key_,
CONCAT('items.php?form=update&itemid=', items.itemid) AS goTo
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND hosts.flags=0
AND items.status=0
AND items.templateid IS NULL
AND items.flags=0;</code></pre>
User sessions. Zabbix 6.0<pre><code>SELECT
COUNT(*),
users.username
FROM sessions
JOIN users ON (users.userid=sessions.userid)
GROUP BY 2 ORDER BY 1 ASC;</code></pre>
User sessions. Zabbix 5.0<pre><code>SELECT
COUNT(*),
users.alias
FROM sessions
JOIN users ON (users.userid=sessions.userid)
GROUP BY 2 ORDER BY 1 ASC;</code></pre>
Open problems. Zabbix 5.0, 6.0<pre><code>SELECT
COUNT(*) AS count,
CASE
WHEN source=0 THEN 'surface'
WHEN source > 0 THEN 'internal'
END AS level,
CASE
WHEN source=0 AND object=0 THEN 'trigger in a problem state'
WHEN source=3 AND object=0 THEN 'cannot evaluate trigger expression'
WHEN source=3 AND object=4 THEN 'data collection not working'
WHEN source=3 AND object=5 THEN 'low level discovery not perfect'
END AS problemCategory
FROM problem GROUP BY 2,3
ORDER BY 2 DESC;</code></pre>
Item update frequency. Zabbix 5.0, 6.0<pre><code>SELECT
h2.host AS Source,
i2.name AS itemName,
i2.key_ AS itemKey,
i2.delay AS OriginalUpdateFrequency,
h1.host AS exceptionInstalledOn,
i1.delay AS FrequencyChild,
CASE
WHEN i1.flags=1 THEN 'LLD rule'
WHEN i1.flags IN (0,4) THEN 'data collection'
END AS itemCategory,
CASE
WHEN i1.flags=1 THEN CONCAT('host_discovery.php?form=update&context=host&itemid=', i1.itemid)
WHEN i1.flags IN (0,4) THEN CONCAT('items.php?form=update&context=host&hostid=', h1.hostid, '&itemid=',i1.itemid)
END AS goTo
FROM items i1
JOIN items i2 ON (i2.itemid=i1.templateid)
JOIN hosts h1 ON (h1.hostid=i1.hostid)
JOIN hosts h2 ON (h2.hostid=i2.hostid)
WHERE i1.delay <> i2.delay;</code></pre>
Unsupported items and LLD rules. Zabbix 5.0<pre><code>SELECT
DISTINCT i.key_,COALESCE(ir.error,'') AS error
FROM hosts h, items i
LEFT JOIN item_rtdata ir ON i.itemid=ir.itemid
WHERE i.type<>9
AND i.flags IN (0,1,4)
AND h.hostid=i.hostid
AND h.status<>3
AND i.status=0
AND ir.state=1
LIMIT 5001;</code></pre>
Which dashboard widgets are using wildcards. Zabbix 6.0<pre><code>SELECT
value_str AS pattern,
widget.name AS widgetName,
dashboard.name AS dashboardName
FROM widget_field, widget, dashboard_page, dashboard
WHERE widget_field.value_str like '%*%'
AND widget.widgetid=widget_field.widgetid
AND dashboard_page.dashboard_pageid=widget.dashboard_pageid
AND dashboard.dashboardid=dashboard_page.dashboard_pageid
ORDER BY 3,2,1;</code></pre>
Remove user refresh overrides in user level. Zabbix 6.0<pre><code>DELETE FROM profiles WHERE idx='web.dashboard.widget.rf_rate';</code></pre>
Print all online users with rights group ID: 13. Zabbix 6.0<pre><code>SELECT
users.username,
CASE
WHEN permission=0 THEN 'DENY'
WHEN permission=2 THEN 'READ_ONLY'
WHEN permission=3 THEN 'READ_WRITE'
END AS permission,
hstgrp.name AS name
FROM users, users_groups, sessions, usrgrp, rights, hstgrp
WHERE sessions.status=0
AND rights.groupid=13
AND users.userid=users_groups.userid
AND users.userid=sessions.userid
AND users_groups.usrgrpid=usrgrp.usrgrpid
AND users_groups.userid=users.userid
AND usrgrp.usrgrpid=rights.groupid
AND rights.id=hstgrp.groupid;</code></pre>
Clear error message for disabled items. Zabbix 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>UPDATE item_rtdata
SET error=''
WHERE state=1
AND itemid IN (
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status=0
AND items.status=1
);</code></pre>
Set state as supported for disabled items. Zabbix 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>UPDATE item_rtdata
SET state=0
WHERE state=1
AND itemid IN (
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status=0
AND items.status=1
);</code></pre>
For hosts which are disable, set all items as supported<pre><code>UPDATE item_rtdata
SET state=0
WHERE state=1
AND itemid IN (
SELECT items.itemid
FROM items, hosts
WHERE hosts.hostid=items.hostid
AND hosts.status=1
AND items.status=0
);</code></pre>
Show internal events for items which is working right now. Zabbix 5.0<pre><code>SELECT events.name FROM events
WHERE source=3 AND object=4
AND objectid NOT IN (
SELECT items.itemid
FROM hosts, items, item_rtdata
WHERE items.hostid=hosts.hostid
AND items.itemid=item_rtdata.itemid
AND hosts.status=0
AND items.status=0
AND hosts.flags IN (0,4)
AND LENGTH(item_rtdata.error)=0
);</code></pre>
Detete internal events for items which is working right now. Zabbix 5.0<pre><code>DELETE FROM events
WHERE source=3 AND object=4
AND objectid NOT IN (
SELECT items.itemid
FROM hosts, items, item_rtdata
WHERE items.hostid=hosts.hostid
AND items.itemid=item_rtdata.itemid
AND hosts.status=0
AND items.status=0
AND hosts.flags IN (0,4)
AND LENGTH(item_rtdata.error)=0
);</code></pre>
Print error active data collector items. Zabbix 4.4, 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>SELECT
hosts.host,
items.name,
item_rtdata.error AS error
FROM items, item_rtdata, hosts
WHERE item_rtdata.state=1
AND hosts.status=0
AND items.status=0
AND item_rtdata.itemid=items.itemid
AND hosts.hostid=items.hostid;</code></pre>
Healthy/active/enabled trigger objects, together with healthy items and healthy/enabled hosts. Zabbix 5.0<pre><code>SELECT DISTINCT triggers.triggerid, hosts.host
FROM triggers, functions, items, hosts, item_rtdata
WHERE triggers.triggerid=functions.triggerid
AND functions.itemid=items.itemid
AND hosts.hostid=items.hostid
AND item_rtdata.itemid=items.itemid
AND hosts.status=0
AND items.status=0
AND triggers.status=0
AND LENGTH(triggers.error)=0
AND LENGTH(item_rtdata.error)=0;</code></pre>
Select internal trigger events for triggers which where not working some time ago, but triggers is healthy now. Zabbix 5.0<pre><code>SELECT name FROM events
WHERE source=3 AND object=0
AND objectid NOT IN (
SELECT DISTINCT triggers.triggerid
FROM triggers, functions, items, hosts, item_rtdata
WHERE triggers.triggerid=functions.triggerid
AND functions.itemid=items.itemid
AND hosts.hostid=items.hostid
AND item_rtdata.itemid=items.itemid
AND hosts.status=0
AND hosts.flags IN (0,4)
AND items.status=0
AND triggers.status=0
AND LENGTH(triggers.error)=0
AND LENGTH(item_rtdata.error)=0
);</code></pre>
Delete INTERNAL trigger events for triggers which is healthy at this very second. Since it's healthy now, we can remove old evidence why it was not working. this will allow to concentrate more preciselly on what other things is not working right now. Zabbix 5.0<pre><code>DELETE FROM events
WHERE source=3 AND object=0
AND objectid NOT IN (
SELECT DISTINCT triggers.triggerid
FROM triggers, functions, items, hosts, item_rtdata
WHERE triggers.triggerid=functions.triggerid
AND functions.itemid=items.itemid
AND hosts.hostid=items.hostid
AND item_rtdata.itemid=items.itemid
AND hosts.status=0
AND hosts.flags IN (0,4)
AND items.status=0
AND triggers.status=0
AND LENGTH(triggers.error)=0
AND LENGTH(item_rtdata.error)=0
);</code></pre>
Show host object and proxy the item belongs to. Zabbix 5.0, 5.2, 5.4, 6.0<pre><code>SELECT
proxy.host AS proxy,
hosts.host,
items.name,
items.key_,
items.delay
FROM items
JOIN hosts ON (items.hostid=hosts.hostid)
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
WHERE hosts.status=0
AND items.status=0;</code></pre>
Unique items keys behind proxy. Zabbix 5.0, 5.2, 5.4, 6.0, 6.2<pre><code>SELECT
proxy.host AS proxy,
items.key_,
COUNT(*) AS count
FROM hosts
LEFT JOIN hosts proxy ON (hosts.proxy_hostid=proxy.hostid)
JOIN items ON (items.hostid=hosts.hostid)
WHERE hosts.status=0
AND items.status=0
AND items.flags<>2
GROUP BY 1,2
ORDER BY 3 ASC;</code></pre>
Size of MySQL DB<pre><code>SELECT
ENGINE,
TABLE_TYPE,
TABLE_SCHEMA AS `DATABASE`,
TABLE_NAME AS `TABLE`,
ROUND(1.0*(DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024,2) AS `TOTAL SIZE (MB)`,
ROUND(1.0*DATA_LENGTH/1024/1024, 2) AS `DATA SIZE (MB)`,
ROUND(1.0*INDEX_LENGTH/1024/1024, 2) AS `INDEX SIZE (MB)`,
ROUND(1.0*DATA_FREE/1024/1024, 2) AS `FREE SIZE (MB)`,
CURDATE() AS `TODAY`,
ROUND(DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100,2) 'FRAGMENTED %',
TABLE_ROWS,
ROW_FORMAT,
TABLE_COLLATION,
VERSION
FROM information_schema.TABLES
WHERE table_schema NOT IN('information_schema', 'mysql','sys', 'performance_schema')
ORDER BY (DATA_LENGTH + INDEX_LENGTH)
DESC;</code></pre>
Show failed actions. Zabbix 5.0<pre><code>SELECT CONCAT('tr_events.php?triggerid=',events.objectid,'&eventid=',events.eventid) AS OpenEventDetails,
FROM_UNIXTIME(alerts.clock) AS clock, alerts.error AS WhyItFailed,
actions.name AS ActionName,
CONCAT('actionconf.php?form=update&actionid=',actions.actionid) AS OpenAction
FROM alerts, events, actions
WHERE alerts.eventid=events.eventid
AND actions.actionid=alerts.actionid
AND alerts.status=2
ORDER BY alerts.clock DESC LIMIT 10;</code></pre>
Detect parallelity<pre><code>SELECT
hosts.host,
items.delay,
MOD(items.itemid,table1.inSeconds) AS offset,
GROUP_CONCAT(items.itemid),
COUNT(*)
FROM items
JOIN (
SELECT DISTINCT delay, CASE delay
WHEN '10s' THEN '10'
WHEN '12s' THEN '12'
WHEN '15s' THEN '15'
WHEN '1m' THEN '60'
WHEN '2m' THEN '120'
WHEN '3m' THEN '180'
WHEN '5m' THEN '300'
WHEN '15m' THEN '900'
WHEN '1h' THEN '3600'
WHEN '1d' THEN '86400'
ELSE '0'
END AS inSeconds
FROM items
) table1 ON table1.delay=items.delay
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0 AND items.status=0
GROUP BY 1,2,3
HAVING COUNT(*) > 1;</code></pre>
Summary of data collection and storage used<pre><code>SELECT items.delay,
items.history,
items.trends, COUNT(*)
FROM items
JOIN hosts
WHERE hosts.hostid=items.hostid
AND items.status=0
AND hosts.status=0
GROUP BY 1,2,3
ORDER BY 4 ASC;</code></pre>
Statistics per calculated item. Zabbix 6.0<pre><code>SELECT items.params,COUNT(*) FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE items.type=15
AND items.status=0
AND hosts.status=0
GROUP BY 1 ORDER BY 2 ASC;</code></pre>
ZBX hosts with errors. Zabbix 6.4<pre><code>SELECT proxy.host, hosts.host, interface.ip,interface.port,interface.error
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
LEFT JOIN hosts proxy ON (proxy.hostid=hosts.proxy_hostid)
WHERE LENGTH(interface.error)>0
AND interface.type=1
ORDER BY 3 ASC;</code></pre>
SNMP hosts with errors. Zabbix 6.4<pre><code>SELECT proxy.host, hosts.host, interface.ip,interface.port,interface.error
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
LEFT JOIN hosts proxy ON (proxy.hostid=hosts.proxy_hostid)
WHERE LENGTH(interface.error)>0
AND interface.type=2
ORDER BY 3 ASC;</code></pre>
JMX hosts with errors. Zabbix 6.4<pre><code>SELECT hosts.host, interface.ip,interface.port,interface.error
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
LEFT JOIN hosts proxy ON (proxy.hostid=hosts.proxy_hostid)
WHERE LENGTH(interface.error)>0
AND interface.type=4
ORDER BY 3 ASC;</code></pre>
Interface errors. Zabbix 6.4<pre><code>SELECT hosts.host, interface.type, interface.error
FROM interface
JOIN hosts ON (hosts.hostid=interface.hostid)
WHERE LENGTH(interface.error)>0
ORDER BY 3 ASC;</code></pre>
Detach current table from application layer and set back another table<pre><code>RENAME TABLE history TO history_old; CREATE TABLE history LIKE history_old;
RENAME TABLE history_uint TO history_uint_old; CREATE TABLE history_uint LIKE history_uint_old;
RENAME TABLE history_str TO history_str_old; CREATE TABLE history_str LIKE history_str_old;
RENAME TABLE history_log TO history_log_old; CREATE TABLE history_log LIKE history_log_old;
RENAME TABLE history_text TO history_text_old; CREATE TABLE history_text LIKE history_text_old;
RENAME TABLE trends TO trends_old; CREATE TABLE trends LIKE trends_old;
RENAME TABLE trends_uint TO trends_uint_old; CREATE TABLE trends_uint LIKE trends_uint_old;</code></pre>
Create old tables like current<pre><code>CREATE TABLE history_old LIKE history;
CREATE TABLE history_uint_old LIKE history_uint;
CREATE TABLE history_str_old LIKE history_str;
CREATE TABLE history_log_old LIKE history_log;
CREATE TABLE history_text_old LIKE history_text;
CREATE TABLE trends_old LIKE trends;
CREATE TABLE trends_uint_old LIKE trends_uint;</code></pre>
Create current tables like old<pre><code>CREATE TABLE history LIKE history_old;
CREATE TABLE history_uint LIKE history_uint_old;
CREATE TABLE history_str LIKE history_str_old;
CREATE TABLE history_log LIKE history_log_old;
CREATE TABLE history_text LIKE history_text_old;
CREATE TABLE trends LIKE trends_old;
CREATE TABLE trends_uint LIKE trends_uint_old;</code></pre>
Truncate old tables<pre><code>TRUNCATE TABLE history_uint_old;
TRUNCATE TABLE trends_uint_old;
TRUNCATE TABLE history_old;
TRUNCATE TABLE trends_old;
TRUNCATE TABLE history_text_old;
TRUNCATE TABLE history_str_old;
TRUNCATE TABLE history_log_old;</code></pre>
Truncate current tables<pre><code>TRUNCATE TABLE history_uint;
TRUNCATE TABLE trends_uint;
TRUNCATE TABLE history;
TRUNCATE TABLE trends;
TRUNCATE TABLE history_text;
TRUNCATE TABLE history_str;
TRUNCATE TABLE history_log;</code></pre>
Items which fails with data collection frequently. Zabbix 4.0, 5.0<pre><code>SELECT
CONCAT('items.php?form=update&itemid=', events.objectid) AS 'URL',
events.name,
COUNT(*)
FROM events
WHERE events.source=3 AND events.object=4 AND LENGTH(events.name)>0
AND clock > UNIX_TIMESTAMP(NOW()-INTERVAL 1 HOUR)
GROUP BY 1,2
ORDER BY 3 DESC LIMIT 10;</code></pre>
Lld rules which fail. Zabbix 4.0, 5.0<pre><code>SELECT
CONCAT('host_discovery.php?form=update&itemid=', events.objectid) AS 'URL',
events.name,
COUNT(*)
FROM events
WHERE events.source=3 AND events.object=5 AND LENGTH(events.name)>0
AND clock > UNIX_TIMESTAMP(NOW()-INTERVAL 1 HOUR)
GROUP BY 1,2
ORDER BY 3 DESC LIMIT 10;</code></pre>
Unexisting integer numbers<pre><code>SELECT DISTINCT itemid FROM trends_uint WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM trends_uint WHERE itemid NOT IN (SELECT itemid FROM items);</code></pre>
Unexisting decimal numbers<pre><code>SELECT DISTINCT itemid FROM trends WHERE itemid NOT IN (SELECT itemid FROM items);
DELETE FROM trends WHERE itemid NOT IN (SELECT itemid FROM items);</code></pre>
Print a part of sid which can be used to backtrack usage of calls in web servers access.log<pre><code>SELECT RIGHT(sessions.sessionid,16), users.alias FROM sessions, users WHERE sessions.userid=users.userid AND users.alias='api';</code></pre>
MySQL biggest tables for database 'zabbix'<pre><code>SELECT table_name, table_rows, data_length, index_length,
ROUND(((data_length + index_length) / 1024 / 1024 / 1024),2) "Size in GB"
FROM information_schema.tables
WHERE table_schema = "zabbix"
ORDER BY ROUND(((data_length + index_length) / 1024 / 1024 / 1024),2) DESC
LIMIT 20;</code></pre>
Items and delay<pre><code>SELECT items.delay, CASE items.type WHEN 0 THEN 'Zabbix agent' WHEN 1 THEN 'SNMPv1 agent' WHEN 2 THEN 'Zabbix trapper' WHEN 3 THEN 'Simple check' WHEN 4 THEN 'SNMPv2 agent' WHEN 5 THEN 'Zabbix internal' WHEN 6 THEN 'SNMPv3 agent' WHEN 7 THEN 'Zabbix agent (active) check' WHEN 8 THEN 'Aggregate' WHEN 9 THEN 'HTTP test (web monitoring scenario step)' WHEN 10 THEN 'External check' WHEN 11 THEN 'Database monitor' WHEN 12 THEN 'IPMI agent' WHEN 13 THEN 'SSH agent' WHEN 14 THEN 'TELNET agent' WHEN 15 THEN 'Calculated' WHEN 16 THEN 'JMX agent' WHEN 17 THEN 'SNMP trap' WHEN 18 THEN 'Dependent item' WHEN 19 THEN 'HTTP agent' WHEN 20 THEN 'SNMP agent' WHEN 21 THEN 'Script item' END AS type,  COUNT(*)
FROM hosts, items
WHERE hosts.hostid=items.hostid
AND hosts.status=0 AND items.status=0 AND hosts.flags IN (0,4) AND items.flags IN (0,4)
GROUP BY 1,2
ORDER BY 1 ASC;</code></pre>
Special item update frequency<pre><code>SELECT items.delay, items.params,  COUNT(*)
FROM hosts, items
WHERE hosts.hostid=items.hostid
AND hosts.status=0 AND items.status=0 AND hosts.flags IN (0,4) AND items.flags IN (0,4)
AND items.type=15
GROUP BY 1,2
ORDER BY 1 ASC;</code></pre>
Events daily<pre><code>SELECT COUNT(*) FROM events WHERE clock >= UNIX_TIMESTAMP("2023-07-20 00:00:00") AND clock < UNIX_TIMESTAMP("2023-07-21 00:00:00");</code></pre>
Trigger calculation fail. Zabbix 4.0, 5.0<pre><code>SELECT
CONCAT('triggers.php?form=update&triggerid=', events.objectid) AS 'URL',
events.name,
COUNT(*)
FROM events
WHERE events.source=3 AND events.object=0 AND LENGTH(events.name)>0
AND clock > UNIX_TIMESTAMP(NOW()-INTERVAL 1 HOUR)
GROUP BY 1,2
ORDER BY 3 DESC LIMIT 10;</code></pre>
<p>Download this section: <a href="src/server.sql">https://aigarskadikis.github.io/src/server.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/server.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/server.sql</a></p>
</div>
<input type="radio" name="tabs" id="ts"><label for="ts">ts.sql</label><div class="tab">
List all chunks. Pg 14.5, ts 2.8.1<pre><code>SELECT show_chunks('history');</code></pre>
Compress manually one chunk. Pg 14.5, ts 2.8.1<pre><code>SELECT compress_chunk('_timescaledb_internal._hyper_1_489_chunk');</code></pre>
Explorer how many is compressed and uncompressed. Pg 14.5, ts 2.8.1<pre><code>SELECT chunk_schema,chunk_name,compression_status FROM chunk_compression_stats('history');</code></pre>
To see if hypertable is compressed. Pg 14.5, ts 2.8.1<pre><code>SELECT chunk_schema,chunk_name,compression_status FROM chunk_compression_stats('history');</code></pre>
Decompress chunk. Pg 14.5, ts 2.8.1<pre><code>SELECT chunk_schema,chunk_name,compression_status FROM chunk_compression_stats('history');</code></pre>
Another way to print chunks per table<pre><code>select * from _timescaledb_catalog.chunk where hypertable_id = (select id from _timescaledb_catalog.hypertable where table_name = 'history');</code></pre>
Compress all chunks from a time frame. Pg 14.5, ts 2.8.1<pre><code>SELECT compress_chunk(i) from SELECT show_chunks('history',1690372501,0) i;</code></pre>
Decompress all chunks. Pg 14.5, ts 2.8.1<pre><code>SELECT decompress_chunk(c, true) FROM show_chunks('trends_uint') c;
SELECT decompress_chunk(c, true) FROM show_chunks('trends') c;
SELECT decompress_chunk(c, true) FROM show_chunks('history_uint') c;
SELECT decompress_chunk(c, true) FROM show_chunks('history_str') c;
SELECT decompress_chunk(c, true) FROM show_chunks('history_log') c;
SELECT decompress_chunk(c, true) FROM show_chunks('history_text') c;
SELECT decompress_chunk(c, true) FROM show_chunks('history') c;</code></pre>
<p>Download this section: <a href="src/ts.sql">https://aigarskadikis.github.io/src/ts.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/ts.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/ts.sql</a></p>
</div>
<input type="radio" name="tabs" id="users"><label for="users">users.sql</label><div class="tab"><p>Create MySQL users using wizard: <a href="./u/index.html">https://aigarskadikis.github.io/u</a></p>
Create an empty database with name 'zbx_db'. Zabbix 6.0 LTS<pre><code>CREATE DATABASE zbx_db CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</code></pre>
DB1. User for replication<pre><code>CREATE USER 'repl'@'192.168.88.101' IDENTIFIED WITH mysql_native_password BY 'PasswordForDBReplication';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.88.101';</code></pre>
DB2. User for replication<pre><code>CREATE USER 'repl'@'192.168.88.102' IDENTIFIED WITH mysql_native_password BY 'PasswordForDBReplication';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.88.102';</code></pre>
APP1. User for 'zabbix-server'<pre><code>CREATE USER 'zbx_srv'@'192.168.88.111' IDENTIFIED WITH mysql_native_password BY 'PasswordForApplicationServer';</code></pre>
APP2. User for 'zabbix-server'<pre><code>CREATE USER 'zbx_srv'@'192.168.88.112' IDENTIFIED WITH mysql_native_password BY 'PasswordForApplicationServer';</code></pre>
Bare minumum permissions for 'zabbix-server'<pre><code>CREATE ROLE 'zbx_srv_role';
GRANT SELECT, UPDATE, DELETE, INSERT, CREATE, DROP, ALTER, INDEX, REFERENCES ON zbx_db.* TO 'zbx_srv_role';</code></pre>
Allow to use Zabbix 6.2. Required for incremental configuration synchronisation<pre><code>SET GLOBAL log_bin_trust_function_creators = 1;</code></pre>
APP1. Assign role<pre><code>GRANT 'zbx_srv_role' TO 'zbx_srv'@'192.168.88.111';
SET DEFAULT ROLE 'zbx_srv_role' TO 'zbx_srv'@'192.168.88.111';</code></pre>
APP2. Assign role<pre><code>GRANT 'zbx_srv_role' TO 'zbx_srv'@'192.168.88.112';
SET DEFAULT ROLE 'zbx_srv_role' TO 'zbx_srv'@'192.168.88.112';</code></pre>
GUI1. User for 'nginx'<pre><code>CREATE USER 'zbx_web'@'192.168.88.121' IDENTIFIED WITH mysql_native_password BY 'PasswordForFrontendNode';</code></pre>
GUI2. User for 'nginx'<pre><code>CREATE USER 'zbx_web'@'192.168.88.122' IDENTIFIED WITH mysql_native_password BY 'PasswordForFrontendNode';</code></pre>
Install bare minimum permissions for frontend<pre><code>CREATE ROLE 'zbx_web_role';
GRANT SELECT, UPDATE, DELETE, INSERT ON zbx_db.* TO 'zbx_web_role';</code></pre>
GUI1. Assign role<pre><code>GRANT 'zbx_web_role' TO 'zbx_web'@'192.168.88.121';
SET DEFAULT ROLE 'zbx_web_role' TO 'zbx_web'@'192.168.88.121';</code></pre>
GUI2. Assign role<pre><code>GRANT 'zbx_web_role' TO 'zbx_web'@'192.168.88.122';
SET DEFAULT ROLE 'zbx_web_role' TO 'zbx_web'@'192.168.88.122';</code></pre>
User for DB partitioning script<pre><code>CREATE USER 'zbx_part'@'127.0.0.1' IDENTIFIED WITH mysql_native_password BY 'PasswordForDBPartitioning';
GRANT ALL PRIVILEGES ON *.* to 'zbx_part'@'127.0.0.1';</code></pre>
User to monitor the health of MySQL server via local Zabbix agent 2. Not suitable for RDS.<pre><code>CREATE USER 'zbx_monitor'@'127.0.0.1' IDENTIFIED WITH mysql_native_password BY 'PasswordForAgent2MySQLMonitoring';
GRANT REPLICATION CLIENT,PROCESS,SHOW DATABASES,SHOW VIEW ON *.* TO 'zbx_monitor'@'127.0.0.1';</code></pre>
APP1. User to monitor RDS database<pre><code>CREATE USER 'zbx_monitor'@'192.168.88.111' IDENTIFIED WITH mysql_native_password BY 'PasswordForAgent2MySQLMonitoring';
GRANT REPLICATION CLIENT,PROCESS,SHOW DATABASES,SHOW VIEW ON *.* TO 'zbx_monitor'@'192.168.88.111';</code></pre>
APP2. User to monitor RDS database<pre><code>CREATE USER 'zbx_monitor'@'192.168.88.112' IDENTIFIED WITH mysql_native_password BY 'PasswordForAgent2MySQLMonitoring';
GRANT REPLICATION CLIENT,PROCESS,SHOW DATABASES,SHOW VIEW ON *.* TO 'zbx_monitor'@'192.168.88.112';</code></pre>
Backup user for 'mysqldump'<pre><code>CREATE USER 'zbx_backup'@'127.0.0.1' IDENTIFIED WITH mysql_native_password BY 'PassfordForMySQLDUmp';
GRANT SELECT, LOCK TABLES, SHOW VIEW, RELOAD ON *.* TO 'zbx_backup'@'127.0.0.1';</code></pre>
Read only user for reporting<pre><code>CREATE USER 'zbx_read_only'@'127.0.0.1' IDENTIFIED WITH mysql_native_password BY 'PasswordForReadOnlyUser';
GRANT SELECT ON zbx_db.* TO 'zbx_backup'@'127.0.0.1';</code></pre>
User for grafana which runs in docker<pre><code>CREATE USER 'grafana'@'%' IDENTIFIED WITH mysql_native_password BY 'PasswordForReadOnlyGrafanaUser';
GRANT SELECT ON zbx_db.* TO 'grafana'@'%';</code></pre>
<p>Download this section: <a href="src/users.sql">https://aigarskadikis.github.io/src/users.sql</a><br />
Fancy syntax highlighter? Read same page on GitHub: <a href="https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/users.sql" target="_blank">https://github.com/aigarskadikis/aigarskadikis.github.io/blob/main/src/users.sql</a></p>
</div>
</div><div id='searchInputArea'><span>SEARCH</span><input type='text' id='searchInput' placeholder='Type at least 1 characters...' onkeyup='onTypeSearchInput(event)' /></div><div id='searchResultDlg'><div id='closeIcon' onclick='onCloseDlg()'>&times;</div><div id='searchResultDlgContent'></div></div><script src='searcher.js'></script></div></body></html>
