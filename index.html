<html>
<style type='text/css'>
.tabs {
  display: flex;
  flex-wrap: wrap;
  width: 100%;
}
 
.tabs label {
  order: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 1rem 2rem;
  margin-right: 0.2rem;
  cursor: pointer;
  background-color: gainsboro;
  font-weight: bold;
}
 
.tabs .tab {
  order: 9;
  flex-grow: 1;
  width: 100%;
  height: 100%;
  display: none;
  padding: 1rem;
  background: #fff;
  padding: 20px;
}
 
.tabs input[type="radio"] {
  display: none;
}
 
.tabs input[type="radio"]:checked + label {
  background: #fff;
}
 
.tabs input[type="radio"]:checked + label + .tab {
  display: block;
}
  
body {
  background: gainsboro;
  min-height: 100vh;
  box-sizing: border-box;
  font-family: monospace;
  font-weight: 300;
  line-height: 1.5;
  font-size: 110%;
  display: flex;
}

pre {padding:0;margin:0 0 1em 0}

</style>

<body><div class="tabs">



<input type="radio" name="tabs" id="tab01" checked="checked"><label for="tab01">bash</label><div class="tab">
# Zabbix server configuration file
<pre><code>grep -v "^$\|#" /etc/zabbix/zabbix_server.conf | sort</code></pre>
# differences between backend nodes
<pre><code>grep -r '=' /etc/zabbix/zabbix_server.d/*</code></pre>
# allow to reload cache from Zabbix frontend
<pre><code>cd /etc/sudoers.d
echo 'zabbix ALL=(ALL) NOPASSWD: /usr/sbin/zabbix_server -R config_cache_reload' | sudo tee zabbix_server_config_cache_reload
chmod 0440 zabbix_server_config_cache_reload</code></pre>
# disk long term throughput, how fast we can create 64GB file
<pre><code>time dd if=/dev/urandom of=/var/lib/mysql/64GB.file bs=1M count=65536 oflag=direct</code></pre>
# activity for each block device, pretty-print  device  names, report task creation and system switching activity.
<pre><code>sar -d -p -w 1</code></pre>
# listening TCP ports
<pre><code>ss --tcp --listen --numeric</code></pre>
# listening TCP ports with process identification
<pre><code>ss --tcp --listen --numeric --process</code></pre>
# check if tcp port listens. make sure it really listens on destination server before checking
<pre><code>nc -v servername 3306</code></pre>
</div>



 
<input type="radio" name="tabs" id="loop"><label for="loop">loop</label><div class="tab">
# rotate between values
<pre><code>echo "
one
two
" | grep -v "^$" | while IFS= read -r LINE
do {
echo $LINE
} done</code></pre>
</div>




<input type="radio" name="tabs" id="tab03"><label for="tab03">SQL</label><div class="tab">
# items in use
<pre><code>SELECT
CASE items.type
WHEN 0 THEN 'Zabbix agent'
WHEN 2 THEN 'Zabbix trapper'
WHEN 3 THEN 'Simple check'
WHEN 5 THEN 'Zabbix internal'
WHEN 7 THEN 'Zabbix agent (active) check'
WHEN 8 THEN 'Aggregate'
WHEN 9 THEN 'HTTP test (web monitoring scenario step)'
WHEN 10 THEN 'External check'
WHEN 11 THEN 'Database monitor'
WHEN 12 THEN 'IPMI agent'
WHEN 13 THEN 'SSH agent'
WHEN 14 THEN 'TELNET agent'
WHEN 15 THEN 'Calculated'
WHEN 16 THEN 'JMX agent'
WHEN 17 THEN 'SNMP trap'
WHEN 18 THEN 'Dependent item'
WHEN 19 THEN 'HTTP agent'
WHEN 20 THEN 'SNMP agent'
END as type,COUNT(*)
FROM items
JOIN hosts ON (hosts.hostid=items.hostid)
WHERE hosts.status=0
AND items.status=0
GROUP BY items.type
ORDER BY COUNT(*) DESC;</code></pre>
# determine which items report unsupported state:
<pre><code>SELECT COUNT(items.key_),
hosts.host,
items.key_,
item_rtdata.error
FROM events
JOIN items ON (items.itemid=events.objectid)
JOIN hosts ON (hosts.hostid=items.hostid)
JOIN item_rtdata ON (item_rtdata.itemid=items.itemid)
WHERE source=3
AND object=4
AND items.status=0
AND items.flags IN (0,1,4)
AND LENGTH(item_rtdata.error)>0
GROUP BY hosts.host,items.key_,
item_rtdata.error
ORDER BY COUNT(items.key_);</code></pre>
# list all function names together with arguments
<pre><code>SELECT functions.name, functions.parameter, COUNT(*)
FROM functions
JOIN items ON (items.itemid = functions.itemid)
JOIN hosts ON (items.hostid = hosts.hostid)
JOIN triggers ON (triggers.triggerid=functions.triggerid)
WHERE hosts.status=0
AND items.status=0
AND triggers.status=0
GROUP BY 1,2
ORDER BY 1;</code></pre>
# Sumarize DB permissions
<pre><code>SELECT CONCAT("'",user,"'@'",host,"'") FROM mysql.user;</code></pre>
# session concat limit
<pre><code>SET SESSION group_concat_max_len = 1000000;</code></pre>
# catter host inventory
<pre><code>SELECT host_inventory.macaddress_a,GROUP_CONCAT(hosts.host) FROM host_inventory
JOIN hosts ON (hosts.hostid=host_inventory.hostid)
WHERE hosts.status=0 AND host_inventory.macaddress_a LIKE '%enterprises%'
GROUP BY host_inventory.macaddress_a\G</code></pre>
</div>



<input type="radio" name="tabs" id="MySQL"><label for="MySQL">MySQL</label><div class="tab">
# Backup data directory. Fastest way time-wise
<pre><code>systemctl stop mysqld && GZIP=--fast tar cvzf /tmp/var.lib.mysql.tar.gz /var/lib/mysql</code></pre>
# Observe credentials how zabbix-server-mysql connects to database
<pre><code>grep ^DB /etc/zabbix/zabbix_server.conf</code></pre>
# Authorize in MySQL
<pre><code>mysql --host=127.0.0.1 --database=zabbixDB --user=zbx_srv --password='zabbix' --port=3306</code></pre>
# Track how DB table partitions grow
<pre><code>cd /var/lib/mysql/zabbix && watch -n1 'ls -Rltr | tail -10'</code></pre>
# List of MySQL tables by size
<pre><code>du -ab /var/lib/mysql > /tmp/size.of.tables.txt
du -ah /var/lib/mysql > /tmp/size.of.tables.human.readable.txt</code></pre>
# How much data is generated daily
<pre><code>du -lah /var/lib/mysql/zabbix | grep "$(date '+p%Y_%m_%d')"</code></pre>
# schema backup for MySQL 8. useful for scripts
<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--flush-logs \
--single-transaction \
--set-gtid-purged=OFF \
--create-options \
--no-data \
zabbix | gzip --fast > schema.sql.gz</code></pre>
# data backup. gz compression
<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--no-create-info \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix > data.sql && \
gzip data.sql</code></pre>

# data backup. xz compression
<pre><code>mysqldump \
--defaults-file=/root/.my.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--no-create-info \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix > data.sql && \
xz data.sql</code></pre>
# on-the-fly configuration backup. check if this is not the node holding the Virtaul IP address. Do a backup on slave
<pre><code>ip a | grep "192.168.88.55" || mysqldump \
--defaults-file=/root/.my.cnf \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--ignore-table=zabbix.history \
--ignore-table=zabbix.history_log \
--ignore-table=zabbix.history_str \
--ignore-table=zabbix.history_text \
--ignore-table=zabbix.history_uint \
--ignore-table=zabbix.trends \
--ignore-table=zabbix.trends_uint \
zabbix | gzip > quick.restore.sql.gz</code></pre>
# schema backup for MySQL 8. credentials in the command
<pre><code>mysqldump \
--host=127.0.0.1 \
--user=root \
--password='zabbix' \
--set-gtid-purged=OFF \
--flush-logs \
--single-transaction \
--create-options \
--no-data \
zabbix | gzip --fast > schema.sql.gz</code></pre>
</div>



<input type="radio" name="tabs" id="watch"><label for="watch">watch</label><div class="tab">
# zabbix_server trapper processes
<pre><code>watch -n1 "ps auxww|grep '[z]abbix_server: trapper'"</code></pre>
# zabbix_server history syncer
<pre><code>watch -n1 "ps auxww|grep '[z]abbix_server: history syncer'"</code></pre>
# What is progress of OPTIMIZE TABLE
<pre><code>watch -n1 "ls -Rltr /var/lib/mysql/zabbix | grep '#sql'"</code></pre>
</div>



<input type="radio" name="tabs" id="log"><label for="log">log</label><div class="tab">
# last 1 million lines from /var/log/zabbix/zabbix_proxy.log
<pre><code>tail -1000000 /var/log/zabbix/zabbix_proxy.log | gzip --best > /tmp/zabbix_proxy.$(date +%Y%m%d.%H%M).log.gz
tail -1000000 /var/log/zabbix/zabbix_proxy.log | xz > /tmp/zabbix_proxy.$(date +%Y%m%d.%H%M).log.xz</code></pre>
# last 1 million lines from /var/log/zabbix/zabbix_server.log
<pre><code>tail -1000000 /var/log/zabbix/zabbix_server.log | gzip --best > /tmp/zabbix_server.$(date +%Y%m%d.%H%M).log.gz
tail -1000000 /var/log/zabbix/zabbix_server.log | xz > /tmp/zabbix_server.$(date +%Y%m%d.%H%M).log.xz</code></pre>
# Which devices are sending SNMP traps and are not yet registred in Zabbix
<pre><code>grep -Eo "unmatched trap received from \S+" /var/log/zabbix/zabbix_server.log | sort | uniq</code></pre>
# query failed
<pre><code>grep "query failed" /var/log/zabbix/zabbix_server.log</code></pre>
# all restarts
<pre><code>grep " Zabbix Server" /var/log/zabbix/zabbix_server.log
zcat /var/log/zabbix/zabbix_server*gz | grep " Zabbix Server" | sort | tail -20</code></pre>
# need to increase some parameters
<pre><code>grep "please increase" /var/log/zabbix/zabbix_server.log
zcat /var/log/zabbix/zabbix_server*gz | grep "please increase" | sort | tail -20</code></pre>
</div>



<input type="radio" name="tabs" id="sql2tsv"><label for="sql2tsv">sql2tsv</label><div class="tab">
# MySQL
<pre><code>echo "SELECT alias,
attempt_failed,
attempt_ip,
FROM_UNIXTIME(attempt_clock)
FROM users" | mysql \
--host='127.0.0.1' \
--user='zbx_web' \
--password='zabbix' \
--database='zabbix' \
--silent \
--skip-column-names \
--batch > /tmp/queue.tsv</code></pre>
# PostgreSQL
<pre><code>tail -1000000 /var/log/zabbix/zabbix_server.log | gzip --best > /tmp/zabbix_server.$(date +%Y%m%d.%H%M).log.gz
tail -1000000 /var/log/zabbix/zabbix_server.log | xz > /tmp/zabbix_server.$(date +%Y%m%d.%H%M).log.xz</code></pre>
</div>


<input type="radio" name="tabs" id="web"><label for="web">web</label><div class="tab">
# Check all variables under /etc
<pre><code>grep -Er "memory_limit|max_execution_time" /etc</code></pre>
</div>



<input type="radio" name="tabs" id="backup"><label for="backup">backup</label><div class="tab">
# Backup directories which can be related to Zabbix
<pre><code>cd /usr/share/zabbix && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/zabbix && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /usr/lib/zabbix && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/cron.d && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /usr/local/bin && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/nginx/conf.d && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}
cd /etc/php-fpm.d && mkdir -p ~/backup${PWD} && cp -a * ~/backup${PWD}</code></pre>
# Backup and compress zabbix server config with a purpose to restore it on other machine
<pre><code>GZIP=-9 tar -zcv /etc/zabbix/zabbix_server.conf | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | gunzip | tar -xv%' && echo</code></pre>
# Backup and compress Zabbix agent 2 config with a purpose to restore it on other machine
<pre><code>GZIP=-9 tar -zcv /etc/zabbix/zabbix_agent2.conf | base64 -w0 | sed 's|^|cd / \&\& echo "|' | sed 's%$%" | base64 --decode | gunzip | tar -xv%' && echo</code></pre>
# Backup and compress partitioning script and configuration files
<pre><code>GZIP=-9 tar -zcv /etc/zabbix/zabbix_partitioning.conf /usr/local/bin/zabbix_partitioning.py /etc/cron.d/zabbix_partitioning | base64 --decode | gunzip | tar -xv%' && echo</code></pre>
</div>


<input type="radio" name="tabs" id="sedi"><label for="sedi">sedi</label><div class="tab">
# Reinstall values which have been already customized
<pre><code>sed -i 's|^CacheUpdateFrequency=.*|CacheUpdateFrequency=120|' /etc/zabbix/zabbix_server.conf && grep ^CacheUpdateFrequency /etc/zabbix/zabbix_server.conf
sed -i 's|^ValueCacheSize=.*|ValueCacheSize=768M|' /etc/zabbix/zabbix_server.conf && grep ^ValueCacheSize /etc/zabbix/zabbix_server.conf
sed -i 's|^TrendCacheSize=.*|TrendCacheSize=256M|' /etc/zabbix/zabbix_server.conf && grep ^TrendCacheSize /etc/zabbix/zabbix_server.conf
sed -i 's|^StartDiscoverers=.*|StartDiscoverers=20|' /etc/zabbix/zabbix_server.conf && grep ^StartDiscoverers /etc/zabbix/zabbix_server.conf</code></pre>
# Summarize configuration file
<pre><code>grep -v "^$\|#" /etc/zabbix/zabbix_server.conf | sort</code></pre>
# Restart and follow log
<pre><code>systemctl restart zabbix-server && tail -f /var/log/zabbix/zabbix_server.log</code></pre>
</div>



<input type="radio" name="tabs" id="el8"><label for="el8">el8</label><div class="tab">
# familiar utilities
dnf -y install strace vim tmux jq git
# install snmptrap(net-snmp-utils), snmpwalk(net-snmp-utils), snmptrapd(net-snmp)
<pre><code>dnf -y install net-snmp-utils net-snmp-perl net-snmp</code></pre>
</div>



</div></body></html>
