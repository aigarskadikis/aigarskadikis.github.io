<!DOCTYPE html>
<body>
<div id='config'>
	
<div>Timezone:<input class='output-replace' name='TimeZone' value='Europe/Riga' data-default=''></div>
<div>Int network:<input class='output-replace' name='InternalNetworkInterface' value='eth1' data-default=''></div>
<div>PG data dir:<input class='output-replace' name='PGDataDir' value='/data' data-default=''></div>
<div>replicator pass:<input class='output-replace' name='ReplicatorPass' value='ReplicatorPass' data-default=''></div>
<div>postgres pass:<input class='output-replace' name='PostgresPass' value='PostgresPass' data-default=''></div>


<div id='servers'><table>
<tr><th></th><th>hostname</th><th>IP</th></tr>
<tr>
<td><code>db1</code></td><td><input class='output-replace' name='db1shorthostname' value='srv1' data-default=''></td>
<td><input class='output-replace' name='db1ip' value='10.133.253.50' data-default=''></td>
</tr>
<tr>
<td><code>db2</code></td><td><input class='output-replace' name='db2shorthostname' value='srv2' data-default=''></td>
<td><input class='output-replace' name='db2ip' value='10.133.253.51' data-default=''></td>
</tr>
<tr>
<td><code>3rd etcd</code></td><td><input class='output-replace' name='voteshorthostname' value='vote' data-default=''></td>
<td><input class='output-replace' name='voteip' value='10.133.253.49' data-default=''></td>
</tr>
</table></div>

<div id='primaryUsers'><table>
<tr><td><code>db name</code></td><td><input class='output-replace' name='NameOfZabbixDB' value='zabbix' data-default=''></td></tr>
<tr><td><code>app user</code></td><td><input class='output-replace' name='UserForApplicationServer' value='zabbix' data-default=''></td></tr>
<tr><td><code>app password</code></td><td><input class='output-replace' name='PasswordForApplicationServer' value='zabbix' data-default=''></td></tr>
</table></div>
</div>
</div>
<pre id='output'></pre>


<style>
* { margin:0; padding:0; }
#output { margin:1rem 0 5rem 1rem; min-height: 30vh; background-color:#fff; float:left;width:50%;z-index:-1; }
#config { padding: 10px; border: 1px solid silver; float:right;min-width:20%; position:fixed; top:1rem;right:20px; background-color:#fff;z-index:9}
#config label { display: block; margin-bottom: 3px;}
td:nth-child(1),td:nth-child(3),th:nth-child(1),th:nth-child(3){text-align:left;padding:0 .5rem;}
td:nth-child(2),td:nth-child(4),th:nth-child(2),th:nth-child(4){text-align:left}
table{padding:.5rem 0}

</style>
<script>
let dom = document.getElementById('output');
let messages = [
"# ON EVERY LINUX SERVER",
"",
"# do not allow apt to promt",
"echo \"\\$nrconf{restart} = 'a';\" | sudo tee /etc/needrestart/conf.d/no-prompt.conf",
"",
"# remove appArmor",
"sudo systemctl stop apparmor",
"sudo systemctl disable apparmor",
"sudo apt remove --assume-yes --purge apparmor",
"systemctl daemon-reload",
"sudo apt -y autoremove",
"",
"# project bash variables",
"mkdir -p ~/bin",
"cd /etc/profile.d",
"cat << 'EOF' > zabbix_setup.sh",
"export DB1='db1ip'",
"export SDB1='db1shorthostname'",
"export DB2='db2ip'",
"export SDB2='db2shorthostname'",
"export VOTE='voteip'",
"export SVOTE='voteshorthostname'",
"export HOST_IP=$(ip addr show InternalNetworkInterface | grep 'inet\\b' | awk '{print $2}' | cut -d/ -f1)",
"export SHORT_HOST_NAME=$(hostname -s)",
"export PATH=$PATH:~/bin",
"EOF",
"chmod o+r /etc/profile.d/zabbix_setup.sh",
"source /etc/profile.d/zabbix_setup.sh",
"env | grep -E \"*DB[0-9]|HOST_IP|SHORT_HOST_NAME|VOTE\" | sort",
"",
"# create 2gb swap",
"sudo dd if=/dev/zero of=/myswap1 bs=1M count=2048 && sudo chown root:root /myswap1 && sudo chmod 0600 /myswap1 && sudo mkswap /myswap1 && sudo swapon /myswap1 && free -m",
"",
"# Install Zabbix repository",
"wget http://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.0-4+ubuntu22.04_all.deb",
"dpkg -i zabbix-release_6.0-4+ubuntu22.04_all.deb",
"apt update",
"",
"# Set a correct time zone:",
"timedatectl set-timezone TimeZone",
"",
"# Make sure the time is synchronized:",
"timedatectl | grep 'System clock synchronized'",
"",
"# Install Zabbix agent, but keep it down",
"apt -y install zabbix-agent2 && systemctl disable --now zabbix-agent2",
"",
"# Prepare troubleshooting and benchmark utilities",
"apt -y install zabbix-get zabbix-sender iperf3 mtr fio strace tree",
"",
"# Install ETCD daemon",
"apt -y install etcd",
"",
"# Destroy old etcd caches",
"systemctl stop etcd",
"ps auxww|grep '[e]tcd'",
"rm /var/lib/etcd/member -rf",
"",
"# ensure the local IP and hostname is not emptu and contains correct values:",
"echo local ip: $HOST_IP",
"echo local short hostname: $SHORT_HOST_NAME",
"",
"# backup original ETCD service definition",
"cp /usr/lib/systemd/system/etcd.service ~/original.etcd.service",
"",
"# Install new definition",
"cd /usr/lib/systemd/system && echo \"[Unit]",
"Description=etcd - highly-available key value store",
"Documentation=https://etcd.io/docs",
"Documentation=man:etcd",
"After=network.target",
"Wants=network-online.target",
"",
"[Service]",
"PermissionsStartOnly=true",
"User=etcd",
"Type=notify",
"ExecStart=/usr/bin/etcd \\\\",
"--name ${SHORT_HOST_NAME} \\\\",
"--data-dir /var/lib/etcd \\\\",
"--initial-advertise-peer-urls https://${HOST_IP}:2380 \\\\",
"--listen-peer-urls https://${HOST_IP}:2380 \\\\",
"--listen-client-urls https://${HOST_IP}:2379,https://127.0.0.1:2379 \\\\",
"--advertise-client-urls https://${HOST_IP}:2379 \\\\",
"--initial-cluster-token etcd-cluster-1 \\\\",
"--initial-cluster db1shorthostname=https://db1ip:2380,db2shorthostname=https://db2ip:2380,voteshorthostname=https://voteip:2380 \\\\",
"--client-cert-auth --trusted-ca-file=/etc/ssl/certs/Zabbix_CA.pem \\\\",
"--cert-file=/var/lib/etcd/certs/server.pem --key-file=/var/lib/etcd/certs/server-key.pem \\\\",
"--peer-client-cert-auth --peer-trusted-ca-file=/etc/ssl/certs/Zabbix_CA.pem \\\\",
"--peer-cert-file=/var/lib/etcd/certs/etcd.pem --peer-key-file=/var/lib/etcd/certs/etcd-key.pem \\\\",
"--initial-cluster-state new \\\\",
"--heartbeat-interval 1000 \\\\",
"--election-timeout 5000",
"Restart=on-failure",
"RestartSec=5",
"LimitNOFILE=65536",
"",
"[Install]",
"WantedBy=multi-user.target",
"Alias=etcd2.service",
"\" |\ ",
"sudo tee etcd.service",
"systemctl daemon-reload",
"",
"# Start the service on multiple servers at the same time. It must reach another pier to start function well:",
"systemctl start etcd",
"",
"# Check cluster state:",
"ETCDCTL_API=3 etcdctl \\",
"--endpoints db1ip:2379,db2ip:2379,voteip:2379 \\",
"--cacert /etc/ssl/certs/Zabbix_CA.pem \\",
"--cert /var/lib/etcd/certs/etcd.pem \\",
"--key /var/lib/etcd/certs/etcd-key.pem \\",
"endpoint status -w table",
"",
"# PREPARE DB SERVER",
"# Install PostgreSQL repostitory",
"sudo sh -c 'echo \"deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'",
"",
"# Import the repository signing key",
"wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg",
"",
"# Update the package lists",
"sudo apt-get update",
"",
"# Install the version 16 of PostgreSQL:",
"sudo apt-get -y install postgresql-16 patroni",
"",
"# Ensure service is funtional",
"systemctl status postgresql",
"",
"# Disable PostgreSQL service",
"systemctl disable postgresql patroni --now",
"",
"# Existing data directory will not be used. Patroni will re-create it later. Let's remove data to have a clean system",
"rm /var/lib/postgresql/* -rf",
"",
"# data directory",
"mkdir -p PGDataDir/16/main",
"chown -R postgres. PGDataDir",
"chmod -R 700 PGDataDir",
"",
"# replace data dir. this will be later used in /etc/postgresql/16/main/postgresql.base.conf",
"sed -i \"s|^data_directory =.*|data_directory = \'PGDataDir/16/main\'|\" /etc/postgresql/16/main/postgresql.conf",
"",
"# isntall prerequsites for TimescaleDB setup",
"sudo apt -y install gnupg postgresql-common apt-transport-https lsb-release wget",
"",
"# Enable product from postgres.org is used",
"/usr/share/postgresql-common/pgdg/apt.postgresql.org.sh",
"",
"# install repository",
"echo \"deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main\" | sudo tee /etc/apt/sources.list.d/timescaledb.list",
"",
"# install GPG key:",
"wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/timescaledb.gpg",
"",
"# install specific version",
"apt update && apt-get -y install timescaledb-2-postgresql-16='2.14.0*' timescaledb-2-loader-postgresql-16='2.14.0*'",
"",
"# tune",
"timescaledb-tune --quiet --yes",
"",
"# backup memory settings",
"cp /etc/postgresql/16/main/postgresql.conf /root",
"",
"# create directory for config and logs:",
"mkdir -p /etc/patroni /var/log/patroni",
"",
"# install default patroni config:",
"echo \"",
"scope: patroni_ha",
"name: ${SHORT_HOST_NAME}",
"namespace: /service/",
"",
"restapi:",
"  listen: ${HOST_IP}:8008",
"  connect_address: ${HOST_IP}:8008",
"  cert: /var/lib/postgresql/certs/restapi.pem",
"  key: /var/lib/postgresql/certs/restapi-key.pem",
"  cacert: /etc/ssl/certs/Zabbix_CA.pem",
"  verify_client: required",
"",
"bootstrap:",
"  method: initdb",
"  dcs:",
"    ttl: 30",
"    loop_wait: 10",
"    retry_timeout: 10",
"    maximum_lag_on_failover: 1048576",
"    master_start_timeout: 300",
"    synchronous_mode: false",
"    synchronous_mode_strict: false",
"    synchronous_node_count: 1",
"    postgresql:",
"      use_pg_rewind: true",
"      use_slots: true",
"      parameters:",
"        archive_command: cd .",
"        archive_mode: on",
"        archive_timeout: 1800s",
"        auto_explain.log_analyze: true",
"        auto_explain.log_buffers: true",
"        auto_explain.log_min_duration: 10s",
"        auto_explain.log_nested_statements: true",
"        auto_explain.log_timing: false",
"        auto_explain.log_triggers: true",
"        auto_explain.log_verbose: true",
"        autovacuum: on",
"        autovacuum_analyze_scale_factor: 0.02",
"        autovacuum_max_workers: 10",
"        autovacuum_naptime: 10",
"        autovacuum_vacuum_cost_delay: -1",
"        autovacuum_vacuum_cost_limit: -1",
"        autovacuum_vacuum_scale_factor: 0.01",
"        bgwriter_delay: 200ms",
"        bgwriter_flush_after: 0",
"        bgwriter_lru_maxpages: 100",
"        bgwriter_lru_multiplier: 2.0",
"        checkpoint_completion_target: 0.9",
"        checkpoint_timeout: 15min",
"        commit_delay: 300",
"        default_statistics_target: 100",
"        effective_cache_size: 1224MB",
"        effective_io_concurrency: 256",
"        enable_partitionwise_aggregate: on",
"        enable_partitionwise_join: on",
"        hot_standby: on",
"        hot_standby_feedback: on",
"        huge_pages: try",
"        idle_in_transaction_session_timeout: 600000",
"        jit: on",
"        log_checkpoints: on",
"        log_directory: /var/log/postgresql",
"        log_filename: 'postgresql-%a.log'",
"        log_line_prefix: '%t [%p-%l] %r %q%u@%d '",
"        log_lock_waits: on",
"        log_rotation_age: 1d",
"        log_rotation_size: 0",
"        log_temp_files: 0",
"        log_truncate_on_rotation: on",
"        logging_collector: on",
"        maintenance_work_mem: 252922kB",
"        max_connections: 1000",
"        max_files_per_process: 4096",
"        max_locks_per_transaction: 64",
"        max_parallel_maintenance_workers: 2",
"        max_parallel_workers: 12",
"        max_parallel_workers_per_gather: 6",
"        max_prepared_transactions: 0",
"        max_replication_slots: 10",
"        max_wal_senders: 10",
"        max_wal_size: 1GB",
"        max_worker_processes: 31",
"        min_wal_size: 512MB",
"        pg_stat_statements.max: 10000",
"        pg_stat_statements.save: off",
"        pg_stat_statements.track: all",
"        random_page_cost: 1.1",
"        seq_page_cost: 1",
"        ssl: on",
"        ssl_ca_file: /etc/ssl/certs/Zabbix_CA.pem",
"        ssl_cert_file: /var/lib/postgresql/certs/postgres.pem",
"        ssl_key_file: /var/lib/postgresql/certs/postgres-key.pem",
"        ssl_max_protocol_version: TLSv1.3",
"        ssl_min_protocol_version: TLSv1.2",
"        shared_buffers: 505845kB",
"        shared_preload_libraries: timescaledb,pg_stat_statements,auto_explain",
"        superuser_reserved_connections: 5",
"        synchronous_commit: on",
"        timescaledb.max_background_workers: 16",
"        track_activities: on",
"        track_counts: on",
"        track_functions: all",
"        track_io_timing: on",
"        vacuum_cost_delay: 2",
"        vacuum_cost_limit: 300",
"        vacuum_cost_page_dirty: 20",
"        vacuum_cost_page_hit: 1",
"        vacuum_cost_page_miss: 10",
"        wal_buffers: 16MB",
"        wal_compression: on",
"        wal_init_zero: off",
"        wal_keep_segments: 2048",
"        wal_keep_size: 30168MB",
"        wal_level: replica",
"        wal_log_hints: on",
"        wal_recycle: off",
"        wal_writer_delay: 200ms",
"        wal_writer_flush_after: 1MB",
"        work_mem: 10116kB",
"  initdb:",
"    - encoding: UTF8",
"    - locale: en_US.UTF-8",
"    - data-checksums",
"",
"postgresql:",
"  listen: 127.0.0.1,${HOST_IP}:5432",
"  connect_address: ${HOST_IP}:5432",
"  use_unix_socket: true",
"  data_dir: PGDataDir/16/main",
"  bin_dir: /usr/lib/postgresql/16/bin",
"  config_dir: /etc/postgresql/16/main",
"  pgpass: /var/lib/postgresql/.pgpass_patroni",
"  authentication:",
"    replication:",
"      username: replicator",
"      password: ReplicatorPass",
"    superuser:",
"      username: postgres",
"      password: PostgresPass",
"  parameters:",
"    unix_socket_directories: /var/run/postgresql",
"  remove_data_directory_on_rewind_failure: false",
"  remove_data_directory_on_diverged_timelines: false",
"  ",
"  create_replica_methods:",
"    - basebackup",
"  basebackup:",
"    max-rate: '1000M'",
"    checkpoint: 'fast'",
"",
"etcd3:",
"  protocol: https",
"  hosts: db1ip:2379,db2ip:2379,voteip:2379",
"  cacert: /etc/ssl/certs/Zabbix_CA.pem",
"  cert: /var/lib/postgresql/certs/pg2etcd.pem",
"  key: /var/lib/postgresql/certs/pg2etcd-key.pem",
"",
"watchdog:",
"  mode: off",
"  device: /dev/watchdog",
"  safety_margin: 5",
"",
"log:",
"  level: INFO",
"  dir: /var/log/patroni",
"  file_num: 7",
"  file_size: 134217728",
"",
"tags:",
"  nofailover: False",
"  noloadbalance: False",
"  clonefrom: False",
"  nosync: False",
"\" | sudo tee /etc/patroni/config.yml",
"",
"# reset owner",
"chown -R postgres. /etc/patroni /var/log/patroni",
"",
"# validate config",
"patroni --validate-config /etc/patroni/config.yml",
"",
"# allow to use all sysyem resources",
"sudo mkdir -p /etc/systemd/system/patroni.service.d && echo \"",
"[Service]",
"LimitNOFILE=262144",
"LimitDATA=infinity",
"LimitSTACK=infinity",
"LimitCORE=infinity",
"LimitRSS=infinity",
"LimitMEMLOCK=infinity",
"LimitMSGQUEUE=infinity",
"LimitFSIZE=infinity",
"\" | sudo tee override.conf",
"",
"# reload daemon",
"systemctl daemon-reload",
"",
"ETCDCTL_API=3 etcdctl \\",
"--endpoints db1ip:2379,db2ip:2379,voteip:2379 \\",
"endpoint status -w table",
"",
"",
"ETCDCTL_API=3 etcdctl \\",
"--endpoints db1ip:2379,db2ip:2379,voteip:2379 \\",
"get / --prefix",
"",
"# backup pg_hba.conf",
"cp /etc/postgresql/16/main/pg_hba.conf /root",
"",
"# install pg_hba.conf",
"cd /etc/postgresql/16/main && echo \"",
"# Database administrative login by Unix domain socket",
"local   all             postgres                                peer",
"",
"# TYPE  DATABASE        USER            ADDRESS                 METHOD",
"",
"# \"local\" is for Unix domain socket connections only",
"local   all             all                                     peer",
"",
"# IPv4 local connections:",
"host    all             all             127.0.0.1/32            scram-sha-256",
"",
"# IPv6 local connections:",
"host    all             all             ::1/128                 scram-sha-256",
"",
"# Allow replication connections from localhost, by a user with the replication privilege",
"local   replication     all                                     peer",
"host    replication     all             127.0.0.1/32            scram-sha-256",
"host    replication     all             ::1/128                 scram-sha-256",
"",
"# Patroni from a remote host to be able to create a replica automatically",
"host    replication     replicator      db1ip/32        scram-sha-256",
"host    replication     replicator      db2ip/32        scram-sha-256",
"",
"# Zabbix backend and frontend",
"host    all             UserForApplicationServer          db1ip/32        scram-sha-256",
"host    all             UserForApplicationServer          db2ip/32        scram-sha-256",
"",
"# Install schema, restore Zabbix backup",
"host    all             UserForApplicationServer          127.0.0.1/32            trust",
"",
"# local monitoring by using Zabbix agent",
"host    all             zbx_monitor     127.0.0.1/32            trust",
"\" | sudo tee pg_hba.conf",
"",
"# on both application servers install HAProxy",
"sudo apt -y install haproxy",
"",
"# stop service",
"systemctl stop haproxy",
"",
"# set config",
"echo \"",
"global",
"maxconn 1000",
"",
"defaults",
"log global",
"mode tcp",
"retries 2",
"timeout client 20d",
"timeout connect 4s",
"timeout server 20d",
"timeout check 5s",
"",
"listen stats",
"mode http",
"bind *:7000",
"stats enable",
"stats uri /",
"",
"listen postgres",
"bind 127.0.0.1:6432",
"option httpchk",
"http-check expect status 200",
"default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions",
"server db1shorthostname db1ip:5432 maxconn 1000 check port 8008",
"server db2shorthostname db2ip:5432 maxconn 1000 check port 8008",
"\" | sudo tee /etc/haproxy/haproxy.cfg","",
"",
"# on DB server Leader",
"sudo apt -y install zabbix-sql-scripts",
"su - postgres",
"createuser --pwprompt UserForApplicationServer",
"createdb -O UserForApplicationServer NameOfZabbixDB",
"zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | PGHOST=127.0.0.1 PGUSER=UserForApplicationServer PGPASSWORD=PasswordForApplicationServer psql NameOfZabbixDB",
"",
"# enable timescaledb extension",
"echo 'CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;' | PGHOST=127.0.0.1 PGUSER=UserForApplicationServer PGPASSWORD=PasswordForApplicationServer psql NameOfZabbixDB",
"cat /usr/share/zabbix-sql-scripts/postgresql/timescaledb.sql | PGHOST=127.0.0.1 PGUSER=UserForApplicationServer PGPASSWORD=PasswordForApplicationServer psql NameOfZabbixDB",
"exit",
"",
"# on both app servers",
"mkdir -p /etc/zabbix/zabbix_server.d && cd /etc/zabbix/zabbix_server.d",
"",
"# on app01 server",
"echo \"",
"HANodeName=${SHORT_HOST_NAME}",
"NodeAddress=${HOST_IP}:10051",
"\" | sudo tee ha.conf",
"",
"",
"# install backend",
"sudo apt -y install zabbix-server-pgsql",
"",
"# configure connection to DB",
"vim /etc/zabbix/zabbix_server.conf",
"",
"",
"",
"",
"",
"",
"",
""
];
let placeholders = document.querySelectorAll('.output-replace');

document.getElementById('config').addEventListener('change', e => {
    if (!e.target.classList.contains('output-replace')) {
        return;
    }

    updateOuput(dom, messages);
});
document.getElementById('config').addEventListener('keyup', e => {
    console.log('keyup');
    if (!e.target.classList.contains('output-replace')) {
        return;
    }

    updateOuput(dom, messages)
});
updateOuput(dom, messages);

function updateOuput(dom, messages) {
    

    let output = messages.join("\r\n");
    let key, value;

    for (let placeholder of placeholders) {
        key = new RegExp(placeholder.getAttribute('name'), 'g');
        value = placeholder.value;

        if (value == '' && placeholder.hasAttribute('data-default')) {
            value = placeholder.getAttribute('data-default');
        }

        output = output.replace(key, value);
    }

    dom.innerHTML = output;
}
</script>
    </body>
</html>

